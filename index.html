<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nora - AI Writing Assistant</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3a3a3a">
    <style>
        @font-face { font-family: 'Iran Yekan'; src: url('https://raw.githubusercontent.com/AsterLywin/Nora/main/Fonts/Iran%20Yekan%20Medium.ttf') format('truetype'); font-weight: bold; font-style: normal; }
        @font-face { font-family: 'San Francisco Bold'; src: url('https://raw.githubusercontent.com/AsterLywin/Nora/main/Fonts/San%20Francisco%20bold.ttf') format('truetype'); font-weight: bold; font-style: normal; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; font-family: 'Iran Yekan', sans-serif; background-color: #161b22; color: #c9d1d9; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        textarea, input { -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text; }
        .main { width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .main.reading-mode { background-color: #202020; }
        .top-bar { display: flex; align-items: center; padding: 5px 15px; position: absolute; top: 0; left: 0; right: 0; height: 30px; background-color: #161b22; border-bottom: 2px solid #484f58; z-index: 15; box-sizing: content-box; }
        .chat-area { flex: 1; width: 100%; height: 100%; padding: 20px; padding-top: 72px; padding-bottom: 80px; /* Increased padding to avoid overlap */ overflow-y: auto; scroll-padding-top: 72px; display: flex; flex-direction: column; box-sizing: border-box; }
        .message-group { margin-bottom: 20px; display: flex; flex-direction: column; width: 100%; position: relative; }
        .message-group:not(:last-child)::after { content: ''; display: block; width: 95%; height: 2px; background-color: #484f58; margin: 10px auto 0; }
        .message { margin-bottom: 5px; line-height: 1.5; position: relative; display: block; width: fit-content; }
        .ai-message { width: 80%; margin: 0 auto 5px; font-family: 'San Francisco Bold', sans-serif; font-size: 16px; white-space: pre-wrap; box-sizing: border-box; }
        .ai-message.rtl { text-align: right; }
        .ai-message.ltr { text-align: left; }
        .ai-message.loading::after { content: ''; display: inline-block; width: 12px; height: 12px; border: 2px solid #2563eb; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
        .loading-timer { margin-right: 5px; font-weight: bold; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- CORRECTED: Input Area Layout for floating button on the RIGHT --- */
        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            pointer-events: none; /* Allows scrolling through the empty area */
        }
        .input-wrapper {
            display: flex;
            justify-content: flex-start; /* Corrected: flex-start aligns to the right in RTL */
            padding: 15px 20px;
        }
        .input-area .send-button {
            width: 50px;
            height: 50px;
            background-color: #2563eb;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            transition: background-color 0.2s;
            pointer-events: auto; /* Re-enable pointer events for the button itself */
        }
        .input-area .send-button:hover { background-color: #4a8bff; }
        .send-button svg { width: 24px; height: 24px; }
        .input-area .send-button:disabled { background-color: #6b7280; cursor: not-allowed; }
        /* --- END OF CHANGES --- */

        .menu-button { position: static; background-color: #2563eb; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; }
        .menu-button.hidden { opacity: 0; pointer-events: none; }
        .menu-button:hover { background-color: #4a8bff; }
        .menu-button svg { width: 20px; height: 20px; transform: rotate(180deg); }
        .chat-title-main { position: static; flex-grow: 1; text-align: right; margin: 0 15px; font-size: 16px; font-family: 'Iran Yekan', sans-serif; color: #c9d1d9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-title-main input { width: 100%; padding: 5px; border: none; border-radius: 5px; outline: none; font-size: 14px; direction: rtl; font-family: 'Iran Yekan', sans-serif; background-color: #30363d; color: #ffffff; }
        .reading-mode-button { position: static; width: 30px; height: 30px; background-color: #2563eb; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .reading-mode-button:hover { background-color: #4a8bff; }
        .reading-mode-button.active { opacity: 0.6; }
        .reading-mode-button svg { width: 20px; height: 20px; }
        .sidebar { position: absolute; top: 0; right: -100%; width: 50%; height: 100%; padding: 15px; border-left: 1px solid #30363d; transition: right 0.3s ease, visibility 0.3s; visibility: hidden; z-index: 20; background-color: #161b22; }
        .sidebar.open { right: 0; visibility: visible; }
        .sidebar h2 { font-size: 16px; margin: 10px 0 15px; font-weight: normal; color: #c9d1d9; }
        .sidebar-actions { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .sidebar-actions button { width: 100%; height: 35px; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sidebar-actions .prompt-button { background-color: #2563eb; }
        .sidebar-actions .prompt-button:hover { background-color: #4a8bff; }
        .sidebar-actions .prompt-button svg { stroke: #ffffff; }
        .sidebar-actions .new-chat-button { background-color: #2563eb; }
        .sidebar-actions .new-chat-button:hover { background-color: #4a8bff; }
        .sidebar-actions .clear-chat-button { background-color: #d32f2f; }
        .sidebar-actions .clear-chat-button:hover { background-color: #f44336; }
        .sidebar-actions .settings-button { background-color: #2563eb; }
        .sidebar-actions .settings-button:hover { background-color: #4a8bff; }
        .sidebar-actions .about-us-button { background-color: #2563eb; }
        .sidebar-actions .about-us-button:hover { background-color: #4a8bff; }
        .sidebar-actions .about-us-button.active { opacity: 0.6; }
        .sidebar-actions button svg { width: 20px; height: 20px; }
        .settings-window { width: 100%; max-width: 180px; margin: 0 auto 15px; padding: 8px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); border: 1px solid #30363d; display: none; background-color: #21262d; opacity: 0; }
        .settings-window.open { display: block; opacity: 1; }
        .settings-container { display: flex; flex-direction: column; gap: 15px; }
        .settings-window input { width: 100%; padding: 8px; border: none; border-radius: 5px; outline: none; font-size: 14px; font-family: 'Iran Yekan', sans-serif; text-align: center; background-color: #30363d; color: #ffffff; box-sizing: border-box; }
        .ai-model-selection { display: flex; flex-direction: column; gap: 10px; }
        .ai-name { font-size: 16px; margin: 0; color: #c9d1d9; }
        .model-option { display: flex; flex-direction: column; }
        .radio-wrapper { display: flex; align-items: center; gap: 8px; position: relative; cursor: pointer; }
        .radio-wrapper input[type="radio"] { display: none; }
        .radio-wrapper label::before { content: ''; width: 16px; height: 16px; border: 2px solid #ffffff; border-radius: 50%; display: inline-block; background-color: transparent; margin-left: 8px; }
        .radio-wrapper input[type="radio"]:checked + label::before { background-color: #2563eb; }
        .radio-wrapper label { font-size: 14px; cursor: pointer; color: #c9d1d9; }
        .radio-wrapper input[type="radio"]:checked + label { color: #2563eb; }
        .model-description { font-size: 12px; color: #8b949e; margin: 5px 0 0 24px; text-align: right; }
        .model-separator { border: 0; height: 1px; background-color: #30363d; margin: 5px 0; }
        .search-bar { margin: 0 0 20px; }
        .search-bar input { width: 100%; padding: 8px; border: none; border-radius: 5px; outline: none; font-size: 14px; font-family: 'Iran Yekan', sans-serif; background-color: #21262d; color: #ffffff; box-sizing: border-box; }
        .chat-item { display: flex; align-items: center; padding: 8px 12px; margin-bottom: 8px; border-radius: 8px; background-color: #21262d; cursor: move; user-select: none; }
        .chat-item.hidden { display: none; }
        .chat-item:hover { background-color: #30363d; }
        .chat-item.active { border: 2px solid #2563eb; }
        .chat-item.delete-pending { border: 2px solid #d32f2f !important; box-shadow: inset 0 0 10px rgba(211, 47, 47, 0.5); }
        .chat-item.dragging { opacity: 0.5; }
        .chat-title { flex: 1; font-size: 14px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #c9d1d9; }
        .chat-actions { display: flex; gap: 8px; }
        .chat-actions button { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        .chat-actions button:hover { opacity: 0.7; }
        .chat-actions button svg { width: 16px; height: 16px; }
        .chat-title input { width: 100%; padding: 5px; border: none; border-radius: 5px; outline: none; font-size: 14px; direction: rtl; font-family: 'Iran Yekan', sans-serif; background-color: #30363d; color: #ffffff; }
        .about-us-content { display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #21262d; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); margin: 20px auto; max-width: 100%; width: 100%; box-sizing: border-box; text-align: center; }
        .about-us-title { font-size: 18px; font-weight: bold; color: #ffffff; margin-bottom: 15px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        .about-us-text { font-size: 14px; color: #c9d1d9; line-height: 1.6; margin-bottom: 20px; padding: 0 10px; text-align: right; width: 100%; box-sizing: border-box; }
        .about-us-links { display: flex; flex-direction: column; align-items: stretch; gap: 10px; width: 100%; }
        .telegram-link, .github-link { display: flex; align-items: center; justify-content: center; padding: 12px 16px; color: #ffffff; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: bold; transition: background-color 0.3s, transform 0.2s; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); white-space: nowrap; }
        .telegram-link:hover, .github-link:hover { transform: translateY(-2px); }
        .telegram-link { background-color: #0088cc; }
        .telegram-link:hover { background-color: #00aaff; }
        .github-link { background-color: #333; }
        .github-link:hover { background-color: #555; }
        .telegram-icon, .github-icon { width: 20px; height: 20px; margin-right: 8px; }
        .github-icon { fill: white; }
        .ai-message-actions { position: absolute; top: 5px; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; }
        .ai-message.rtl .ai-message-actions { left: -45px; }
        .ai-message.ltr .ai-message-actions { right: -45px; }
        .message:hover .ai-message-actions, .ai-message.error .ai-message-actions { opacity: 1; pointer-events: auto; }
        .ai-message-actions .options-button { width: 30px; height: 30px; border-radius: 50%; background-color: #1e40af; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ai-message-actions .options-button:hover { background-color: #2563eb; }
        .ai-message-actions .options-button svg { width: 20px; height: 20px; }
        .ai-message-context-menu { position: absolute; display: none; width: fit-content; white-space: nowrap; background-color: #30363d; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); z-index: 25; padding: 5px; top: 35px; }
        .ai-message.rtl .ai-message-context-menu { left: 0; }
        .ai-message.ltr .ai-message-context-menu { right: 0; }
        .ai-message-context-menu.show { display: block; }
        .ai-message-context-menu button { width: 100%; padding: 8px 12px; background: none; border: none; color: #c9d1d9; cursor: pointer; text-align: right; font-family: 'Iran Yekan', sans-serif; font-size: 14px; border-radius: 5px; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .ai-message-context-menu button:hover { background-color: #484f58; }
        .ai-message-context-menu button.regenerate-action { color: #38bdf8; }
        .ai-message-context-menu button.regenerate-action:hover { background-color: rgba(56, 189, 248, 0.2); }
        .ai-message-context-menu button svg { width: 16px; height: 16px; fill: none; }
        .ai-message-context-menu button.regenerate-action .regenerate-svg { stroke: #38bdf8; }
        .main.reading-mode .top-bar { background-color: #202020; }
        .main.reading-mode .chat-area { padding: 0; padding-top: 62px; scroll-padding-top: 62px; }
        .main.reading-mode .menu-button, .main.reading-mode .ai-message-actions, .main.reading-mode .input-area { display: none !important; }
        .main.reading-mode .ai-message.rtl, .main.reading-mode .ai-message.ltr { width: 90%; margin: 0 auto 10px; padding: 10px 15px; color: #b7b7b7; text-align: right; }
        #notification-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast-notification { font-family: 'Iran Yekan', sans-serif; padding: 10px 20px; border-radius: 8px; color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-notification.success { background-color: #28a745; }
        .toast-notification.error { background-color: #d32f2f; }
        .toast-notification.info { background-color: #17a2b8; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .modal-content { background-color: #21262d; padding: 20px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; font-family: 'Iran Yekan', sans-serif; }
        .modal-title { font-size: 18px; color: #c9d1d9; margin: 0; text-align: center; }
        .modal-description { font-size: 13px; color: #8b949e; margin: 0; text-align: center; line-height: 1.5; }
        .modal-textarea { width: 100%; min-height: 150px; padding: 10px; border: 1px solid #30363d; border-radius: 8px; outline: none; resize: vertical; font-size: 14px; font-family: 'Iran Yekan', sans-serif; background-color: #161b22; color: #c9d1d9; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background-color 0.2s; }
        .modal-button.confirm { background-color: #2563eb; color: #ffffff; }
        .modal-button.confirm:hover { background-color: #4a8bff; }
        .modal-button.cancel { background-color: #484f58; color: #c9d1d9; }
        .modal-button.cancel:hover { background-color: #6e7681; }
    </style>
</head>
<body>
    <div class="main" id="main">
        <div class="top-bar">
            <button class="menu-button" onclick="toggleMenu()" title="منو">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 6L21 6.00078M8 12L21 12.0008M8 18L21 18.0007M3 6.5H4V5.5H3V6.5ZM3 12.5H4V11.5H3V12.5ZM3 18.5H4V17.5H3V18.5Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="chat-title-main" id="chat-title-main"></div>
            <button class="reading-mode-button" id="reading-mode-button" onclick="toggleReadingMode()" title="حالت مطالعه">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.99902 3L20.999 21M9.8433 9.91364C9.32066 10.4536 8.99902 11.1892 8.99902 12C8.99902 13.6569 10.3422 15 11.999 15C12.8215 15 13.5667 14.669 14.1086 14.133M6.49902 6.64715C4.59972 7.90034 3.15305 9.78394 2.45703 12C3.73128 16.0571 7.52159 19 11.9992 19C13.9881 19 15.8414 18.4194 17.3988 17.4184M10.999 5.04939C11.328 5.01673 11.6617 5 11.9992 5C16.4769 5 20.2672 7.94291 21.5414 12C21.2607 12.894 20.8577 13.7338 20.3522 14.5" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <div class="chat-area" id="chat-area"></div>
        
        <div class="input-area">
            <div class="input-wrapper">
                <!-- *** CHANGED: Added 'disabled' attribute to the button by default *** -->
                <button class="send-button" onclick="continueStory()" title="شروع / ادامه داستان (Ctrl+Enter)" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.5003 12H5.41872M5.24634 12.7972L4.24158 15.7986C3.69128 17.4424 3.41613 18.2643 3.61359 18.7704C3.78506 19.21 4.15335 19.5432 4.6078 19.6701C5.13111 19.8161 5.92151 19.4604 7.50231 18.7491L17.6367 14.1886C19.1797 13.4942 19.9512 13.1471 20.1896 12.6648C20.3968 12.2458 20.3968 11.7541 20.1896 11.3351C19.9512 10.8529 19.1797 10.5057 17.6367 9.81135L7.48483 5.24303C5.90879 4.53382 5.12078 4.17921 4.59799 4.32468C4.14397 4.45101 3.77572 4.78336 3.60365 5.22209C3.40551 5.72728 3.67772 6.54741 4.22215 8.18767L5.24829 11.2793C5.34179 11.561 5.38855 11.7019 5.407 11.8459C5.42338 11.9738 5.42321 12.1032 5.40651 12.231C5.38768 12.375 5.34057 12.5157 5.24634 12.7972Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <!-- Sidebar content remains unchanged -->
        </div>
    </div>
    
    <div id="prompt-modal" class="modal-overlay">
        <!-- Modal content remains unchanged -->
    </div>

    <div id="regenerate-modal" class="modal-overlay">
        <!-- Modal content remains unchanged -->
    </div>

    <div id="notification-container"></div>

    <script>
        // *** CHANGED: COMPLETE REWORK OF WORKER INITIALIZATION AND STATE HANDLING ***

        let worker;
        if (window.Worker) {
            worker = new Worker('./worker.js', { type: 'module' }); 

            // Show a smart notification based on whether it's the user's first visit
            const isFirstVisit = !localStorage.getItem('nora_visited_before');
            if (isFirstVisit) {
                showNotification('به نورا خوش آمدید! در حال آماده‌سازی اولیه...', 'info');
                localStorage.setItem('nora_visited_before', 'true');
            } else {
                showNotification('دستیار هوشمند در حال بارگذاری...', 'info');
            }
            
            worker.onmessage = function(e) {
                const { type, payload } = e.data;
                if (type === 'log' || type === 'error') {
                    console[type]('[Worker]', payload);
                } 
                // *** ADDED: Listener for the 'ready' message from the worker ***
                else if (type === 'ready') {
                    showNotification('دستیار هوشمند آماده است.', 'success');
                    // Enable the main button now that the AI is ready
                    document.querySelector('.send-button').disabled = false;
                } 
                else if (type === 'context-retrieved') {
                    handleContextRetrieved(payload);
                } else if (type === 'add-to-memory-done') {
                    console.log(`[Worker] Content for message ${payload.messageId} added to memory.`);
                }
            };
            
            worker.onerror = function(e) {
                e.preventDefault(); 
                console.error(`[Worker] Unhandled Error: Line ${e.lineno} in ${e.filename}: ${e.message}`, e);
                alert(`خطای بحرانی در بارگذاری دستیار:\n\nفایل: ${e.filename}\nشماره خط: ${e.lineno}\n\nپیام: ${e.message}\n\nلطفا از این پیام اسکرین‌شات بگیرید.`);
                showNotification('خطای بحرانی در بارگذاری دستیار.', 'error');
                // Even on error, enable the button so the user isn't stuck
                document.querySelector('.send-button').disabled = false;
            };

        } else {
            alert('مرورگر شما از Web Workers پشتیبانی نمی‌کند. عملکرد برنامه ممکن است مختل شود.');
        }

        // --- All other variables and functions from here are mostly unchanged, except for continueStory() ---
        
        let chats = [];
        try {
            chats = JSON.parse(localStorage.getItem('chats')) || [];
        } catch (e) {
            console.error("Could not parse chats from localStorage:", e);
            chats = [];
        }
        
        let currentChatId = chats.length > 0 ? chats[chats.length - 1].id : 0;
        let readingMode = false;
        let draggedChat = null;
        
        let settings = {};
        try {
            settings = JSON.parse(localStorage.getItem('settings')) || { apiKey: '', selectedModel: 'gemini-2.0-flash' };
        } catch (e) {
            console.error("Could not parse settings from localStorage:", e);
            settings = { apiKey: '', selectedModel: 'gemini-2.0-flash' };
        }
        
        let isCreatingChat = false;
        let aboutUsActive = false;
        let messageIdCounter = chats.reduce((max, chat) => { const maxChatId = chat.messages.reduce((m, msg) => Math.max(m, msg.id || 0), 0); return Math.max(max, maxChatId); }, 0) + 1;
        let isGenerating = false;
        let activeGeneration = null;
        let saveTimeout = null;
        let currentRegenerateMessageId = null;

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `toast-notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => {
                    if (notification.parentElement === container) {
                         container.removeChild(notification);
                    }
                }, { once: true });
            }, 3000);
        }

        async function _callGeminiAPI(fullPrompt, apiKey, modelName, signal) {
            const apiUrl = `https://generativelace.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };
            const response = await fetch(apiUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload), signal });
            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData?.error?.message || `خطای ناشناخته با کد ${response.status}`;
                switch (response.status) {
                    case 400: throw new Error("درخواست ارسال شده به مدل هوش مصنوعی ناقص یا اشتباه است.");
                    case 403: throw new Error("کلید API وارد شده نامعتبر است یا دسترسی لازم را ندارد.");
                    case 429: throw new Error("تعداد درخواست‌ها به سرور هوش مصنوعی بیش از حد مجاز بوده است.");
                    case 500: throw new Error("یک خطای داخلی در سرور هوش مصنوعی رخ داده است.");
                    case 503: throw new Error("سرویس هوش مصنوعی در حال حاضر در دسترس نیست.");
                    default: throw new Error(`خطای API: ${errorMessage}`);
                }
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0].finishReason === 'SAFETY') {
                throw new Error("تولید متن به دلیل فعال شدن فیلترهای ایمنی گوگل متوقف شد.");
            }
            const generatedText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!generatedText) throw new Error("پاسخ دریافتی از API خالی یا نامعتبر است.");
            return generatedText;
        }
        
        async function handleContextRetrieved(payload) {
            const { context, messageId, regenerationInstruction } = payload;
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!currentChat || !activeGeneration || activeGeneration.messageId !== messageId) return;

            const aiMessageElement = activeGeneration.messageGroup.querySelector('.ai-message');
            aiMessageElement.firstChild.textContent = 'در حال نوشتن داستان...';
            
            const lastMessageText = currentChat.messages.length > 0 ? currentChat.messages[currentChat.messages.length - 1].text : "این اولین بخش داستان است.";

            let fullPrompt = `${currentChat.prompt}\n\n`;
            if (context && context.length > 0) {
                 fullPrompt += `## خلاصه و بخش‌های مرتبط قبلی داستان:\n${context}\n\n`;
            }
            fullPrompt += `## آخرین بخش نوشته شده از داستان:\n${lastMessageText}\n\n`;
            
            if(regenerationInstruction){
                fullPrompt += `## دستورالعمل اصلاحی:\n${regenerationInstruction}\n\n## وظیفه:\nبر اساس دستورالعمل بالا، بخش آخر داستان را بازنویسی کن.\n`;
            } else {
                 fullPrompt += `## وظیفه:\nادامه داستان را بنویس.\n`;
            }

            try {
                const generatedText = await _callGeminiAPI(fullPrompt, settings.apiKey, settings.selectedModel, activeGeneration.controller.signal);
                
                const messageIndex = currentChat.messages.findIndex(m => m.id === messageId);
                if (messageIndex !== -1) {
                    currentChat.messages[messageIndex].text = generatedText;
                }
                saveChatsDebounced();

                const directionClass = isRTL(generatedText) ? 'rtl' : 'ltr';
                aiMessageElement.className = `message ai-message ${directionClass}`;
                aiMessageElement.innerHTML = '';
                const messageBdi = document.createElement('bdi');
                messageBdi.textContent = generatedText;
                aiMessageElement.appendChild(messageBdi);
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'ai-message-actions';
                actionsDiv.innerHTML = `<button class="options-button" onclick="toggleAiMessageMenu(event, this)"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><div class="ai-message-context-menu"><button class="regenerate-action" onclick="openRegenerateModal(${messageId})" title="اصلاح و بازنویسی"><svg class="regenerate-svg" viewBox="0 0 24 24" width="18" height="18"><path d="M23 4v6h-6" stroke-width="2"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" stroke-width="2"></path></svg><span>اصلاح و بازنویسی</span></button></div>`;
                aiMessageElement.appendChild(actionsDiv);

                worker.postMessage({ type: 'add-to-memory', payload: { chatId: currentChatId, messageId: messageId, text: generatedText } });

            } catch(error) {
                handleGenerationError(error, aiMessageElement, messageId);
            } finally {
                clearInterval(activeGeneration.timerInterval);
                isGenerating = false;
                activeGeneration = null;
                document.querySelector('.send-button').disabled = false;
            }
        }
        
        function handleGenerationError(error, aiMessageElement, messageId) {
             if (error.name === 'AbortError') {
                console.log("Generation aborted by user.");
                return;
            }
            console.error("Generation failed:", error);
            aiMessageElement.className = 'message ai-message rtl error';
            aiMessageElement.innerHTML = '';
            const errorMessageBdi = document.createElement('bdi');
            errorMessageBdi.textContent = `خطا: ${error.message}`;
            aiMessageElement.appendChild(errorMessageBdi);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'ai-message-actions';
            actionsDiv.innerHTML = `<button class="options-button" onclick="toggleAiMessageMenu(event, this)"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><div class="ai-message-context-menu"><button class="regenerate-action" onclick="openRegenerateModal(${messageId})" title="اصلاح و بازنویسی"><svg class="regenerate-svg" viewBox="0 0 24 24" width="18" height="18"><path d="M23 4v6h-6" stroke-width="2"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" stroke-width="2"></path></svg><span>اصلاح و بازنویسی</span></button></div>`;
            aiMessageElement.appendChild(actionsDiv);

            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (currentChat) {
                const msgIndex = currentChat.messages.findIndex(m => m.id === messageId);
                if (msgIndex > -1) {
                    currentChat.messages[msgIndex].text = `خطا: ${error.message}`;
                    saveChatsDebounced();
                }
            }
        }
        
        // *** CHANGED: Added checks for button state ***
        async function continueStory(instruction = null) {
            const sendButton = document.querySelector('.send-button');
            if (isGenerating || sendButton.disabled) {
                if (sendButton.disabled) {
                    showNotification("لطفا صبر کنید، دستیار هوشمند هنوز آماده نشده.", "info");
                }
                return;
            }
            
            const chatArea = document.getElementById('chat-area');
            if (chats.length === 0) createNewChat();
            
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!settings.apiKey) {
                showNotification("لطفا ابتدا کلید API خود را در تنظیمات وارد کنید.", 'error');
                return;
            }
            if (!currentChat.prompt) {
                showNotification("لطفا ابتدا یک پرامپت برای داستان خود وارد کنید.", 'error');
                openPromptModal();
                return;
            }

            isGenerating = true;
            sendButton.disabled = true;

            const isFirstMessage = currentChat.messages.length === 0;

            const messageId = messageIdCounter++;
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            messageGroup.setAttribute('data-group-id', messageId);

            const aiMessage = document.createElement('div');
            aiMessage.className = `message ai-message rtl loading`;
            aiMessage.setAttribute('data-message-id', messageId);
            const timerSpan = document.createElement('span');
            timerSpan.className = 'loading-timer';
            
            aiMessage.textContent = 'در حال جستجو در حافظه... ';

            aiMessage.appendChild(timerSpan);
            messageGroup.appendChild(aiMessage);
            chatArea.appendChild(messageGroup);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            currentChat.messages.push({ id: messageId, type: 'ai', text: 'در حال پردازش...' });
            saveChatsDebounced();

            const controller = new AbortController();
            let seconds = 0;
            const timerInterval = setInterval(() => { seconds++; timerSpan.textContent = `(${seconds}s)`; }, 1000);
            activeGeneration = { messageId, chatId: currentChatId, messageGroup, controller, timerInterval };

            const lastMessage = currentChat.messages.length > 1 ? currentChat.messages[currentChat.messages.length - 2].text : 'شروع داستان';
            
            worker.postMessage({ 
                type: 'get-context', 
                payload: { 
                    chatId: currentChatId,
                    queryText: instruction || `ادامه داستان بعد از: ${lastMessage}`,
                    messageId: messageId,
                    regenerationInstruction: instruction
                } 
            });
        }
        
        async function regenerateStory(instruction) {
             if (isGenerating || currentRegenerateMessageId === null) return;
            const sendButton = document.querySelector('.send-button');
            const chatArea = document.getElementById('chat-area');
            
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!settings.apiKey) {
                showNotification("لطفا ابتدا کلید API خود را در تنظیمات وارد کنید.", 'error');
                return;
            }
           
            isGenerating = true;
            sendButton.disabled = true;
            
            const messageId = currentRegenerateMessageId; 
            const messageGroup = document.querySelector(`.message-group[data-group-id="${messageId}"]`);
            if(!messageGroup) {
                console.error("Could not find message group to regenerate.");
                isGenerating = false;
                sendButton.disabled = false;
                return;
            }
            const aiMessage = messageGroup.querySelector('.ai-message');
            
            aiMessage.className = `message ai-message rtl loading`;
            const timerSpan = document.createElement('span');
            timerSpan.className = 'loading-timer';
            aiMessage.textContent = 'در حال جستجو در حافظه... ';
            aiMessage.appendChild(timerSpan);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            const messageIndex = currentChat.messages.findIndex(m => m.id === messageId);
            currentChat.messages[messageIndex].text = 'در حال پردازش...';
            saveChatsDebounced();

            const controller = new AbortController();
            let seconds = 0;
            const timerInterval = setInterval(() => { seconds++; timerSpan.textContent = `(${seconds}s)`; }, 1000);
            activeGeneration = { messageId, chatId: currentChatId, messageGroup, controller, timerInterval };

            const previousMessageText = messageIndex > 0 ? currentChat.messages[messageIndex - 1].text : 'شروع داستان';
            
            worker.postMessage({ 
                type: 'get-context', 
                payload: { 
                    chatId: currentChatId,
                    queryText: instruction, 
                    messageId: messageId,
                    regenerationInstruction: instruction
                } 
            });
        }

        // --- All other functions (save, render, UI toggles, etc.) remain unchanged. ---
        function saveChats() { localStorage.setItem('chats', JSON.stringify(chats)); }
        function saveChatsDebounced() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { saveChats(); console.log("Chat data saved."); }, 500); }
        function saveSettings() { localStorage.setItem('settings', JSON.stringify(settings)); }
        function isRTL(text) { const rtlRegex = /[\u0600-\u06FF\u0750-\u077F]/; return rtlRegex.test(text); }
        
        function renderChatList() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.setAttribute('data-chat-id', chat.id);
                chatItem.setAttribute('draggable', 'true');
                chatItem.classList.toggle('active', chat.id === currentChatId);
                chatItem.innerHTML = ` <div class="chat-title">${chat.title}</div> <div class="chat-actions"> <button class="edit-button" onclick="editChatTitle(${chat.id}, this)" title="ویرایش نام"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="#FF8300" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button> <button class="delete-button" onclick="deleteChat(${chat.id}, this)" title="حذف چت"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M14 10V17M10 10V17" stroke="#d32f2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button> </div> `;
                chatItem.querySelector('.chat-title').addEventListener('click', () => { loadChat(chat.id); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); });
                chatItem.addEventListener('dragstart', handleDragStart);
                chatItem.addEventListener('dragover', handleDragOver);
                chatItem.addEventListener('drop', handleDrop);
                chatItem.addEventListener('dragend', handleDragEnd);
                chatList.appendChild(chatItem);
            });
        }
        
        function loadChat(chatId) {
            currentChatId = chatId;
            const chatArea = document.getElementById('chat-area');
            const chatTitleMain = document.getElementById('chat-title-main');
            chatArea.innerHTML = '';
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                chat.messages.forEach(message => {
                    const messageGroup = document.createElement('div');
                    messageGroup.className = 'message-group';
                    messageGroup.setAttribute('data-group-id', message.id);
                    
                    const messageDiv = document.createElement('div');
                    const directionClass = isRTL(message.text) ? 'rtl' : 'ltr';
                    messageDiv.className = `message ai-message ${directionClass}`;
                    messageDiv.setAttribute('data-message-id', message.id);

                    if (message.text === 'در حال پردازش...') {
                        messageDiv.classList.add('loading');
                        messageDiv.textContent = message.text;
                    } else {
                        const messageBdi = document.createElement('bdi');
                        messageBdi.textContent = message.text;
                        messageDiv.appendChild(messageBdi);
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'ai-message-actions';
                        if (message.text.startsWith('خطا:')) {
                            messageDiv.classList.add('error');
                        }
                        actionsDiv.innerHTML = `<button class="options-button" onclick="toggleAiMessageMenu(event, this)"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><div class="ai-message-context-menu"><button class="regenerate-action" onclick="openRegenerateModal(${message.id})" title="اصلاح و بازنویسی"><svg class="regenerate-svg" viewBox="0 0 24 24" width="18" height="18"><path d="M23 4v6h-6" stroke-width="2"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" stroke-width="2"></path></svg><span>اصلاح و بازنویسی</span></button></div>`;
                        messageDiv.appendChild(actionsDiv);
                    }
                    messageGroup.appendChild(messageDiv);
                    chatArea.appendChild(messageGroup);
                });
                chatTitleMain.textContent = chat.title;
                chatTitleMain.ondblclick = () => editMainChatTitle(chatId);
                chatTitleMain.oncontextmenu = (e) => { e.preventDefault(); editMainChatTitle(chatId); };
            }
            renderChatList();
        }

        function handleDragStart(e) { draggedChat = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', this.getAttribute('data-chat-id')); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleDrop(e) { e.preventDefault(); const targetChat = this; const draggedId = parseInt(draggedChat.getAttribute('data-chat-id')); const targetId = parseInt(targetChat.getAttribute('data-chat-id')); if (draggedId !== targetId) { const draggedIndex = chats.findIndex(chat => chat.id === draggedId); const targetIndex = chats.findIndex(chat => chat.id === targetId); const [draggedItem] = chats.splice(draggedIndex, 1); chats.splice(targetIndex, 0, draggedItem); saveChatsDebounced(); renderChatList(); } }
        function handleDragEnd() { this.classList.remove('dragging'); draggedChat = null; }
        function createNewChat() { if (isCreatingChat) return; isCreatingChat = true; const existingIds = chats.map(chat => chat.id); let newId = 1; while (existingIds.includes(newId)) newId++; const newChat = { id: newId, title: `چت ${newId}`, messages: [], prompt: '' }; chats.push(newChat); currentChatId = newChat.id; saveChatsDebounced(); renderChatList(); loadChat(currentChatId); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); isCreatingChat = false; worker.postMessage({ type: 'create-collection', payload: { chatId: newId } }); }
        function clearChat() { const chatArea = document.getElementById('chat-area'); chatArea.innerHTML = ''; const currentChat = chats.find(chat => chat.id === currentChatId); if (currentChat) { currentChat.messages = []; saveChatsDebounced(); worker.postMessage({ type: 'clear-collection', payload: { chatId: currentChat.id } }); } }
        function searchChats(query) { const chatItems = document.querySelectorAll('.chat-item'); chatItems.forEach(item => { const chatId = parseInt(item.getAttribute('data-chat-id')); const chat = chats.find(c => c.id === chatId); const title = chat.title.toLowerCase(); if (title.includes(query.toLowerCase())) item.classList.remove('hidden'); else item.classList.add('hidden'); }); }
        function findScrollAnchor() { const chatArea = document.getElementById('chat-area'); const chatAreaRect = chatArea.getBoundingClientRect(); const messageGroups = chatArea.querySelectorAll('.message-group'); let firstVisibleGroup = null; for (const group of messageGroups) { const groupRect = group.getBoundingClientRect(); if (groupRect.bottom > chatAreaRect.top && groupRect.top < chatAreaRect.bottom) { firstVisibleGroup = group; break; } } if (!firstVisibleGroup) return null; const groupRect = firstVisibleGroup.getBoundingClientRect(); const distanceScrolledIntoElement = chatAreaRect.top - groupRect.top; let scrollPercentage = 0; if (distanceScrolledIntoElement > 0) scrollPercentage = distanceScrolledIntoElement / groupRect.height; return { element: firstVisibleGroup, percentage: scrollPercentage }; }
        function restoreScrollPosition(anchor) { if (!anchor || !anchor.element) return; const chatArea = document.getElementById('chat-area'); const element = anchor.element; const elementTopRelativeToContainer = element.offsetTop; const newPixelOffset = element.offsetHeight * anchor.percentage; chatArea.scrollTop = elementTopRelativeToContainer + newPixelOffset; }
        function toggleReadingMode() { const main = document.getElementById('main'); const readingModeButton = document.getElementById('reading-mode-button'); const anchor = findScrollAnchor(); readingMode = !readingMode; main.classList.toggle('reading-mode', readingMode); function enterFullScreen() { const elem = document.documentElement; if (elem.requestFullscreen) { elem.requestFullscreen(); } else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } } function exitFullScreen() { if (document.exitFullscreen) { document.exitFullscreen(); } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } } const eyeIconSVG = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.0007 12C15.0007 13.6569 13.6576 15 12.0007 15C10.3439 15 9.00073 13.6569 9.00073 12C9.00073 10.3431 10.3439 9 12.0007 9C13.6576 9 15.0007 10.3431 15.0007 12Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.0012 5C7.52354 5 3.73326 7.94288 2.45898 12C3.73324 16.0571 7.52159 19 12.0012 19C16.4788 19 20.2691 16.0571 21.5434 12C20.2691 7.94291 16.4788 5 12.0012 5Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`; const eyeSlashIconSVG = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.99902 3L20.999 21M9.8433 9.91364C9.32066 10.4536 8.99902 11.1892 8.99902 12C8.99902 13.6569 10.3422 15 11.999 15C12.8215 15 13.5667 14.669 14.1086 14.133M6.49902 6.64715C4.59972 7.90034 3.15305 9.78394 2.45703 12C3.73128 16.0571 7.52159 19 11.9992 19C13.9881 19 15.8414 18.4194 17.3988 17.4184M10.999 5.04939C11.328 5.01673 11.6617 5 11.9992 5C16.4769 5 20.2672 7.94291 21.5414 12C21.2607 12.894 20.8577 13.7338 20.3522 14.5" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`; readingModeButton.innerHTML = readingMode ? eyeIconSVG : eyeSlashIconSVG; readingModeButton.title = readingMode ? 'خروج از حالت مطالعه' : 'حالت مطالعه'; if (readingMode) { enterFullScreen(); } else { exitFullScreen(); } requestAnimationFrame(() => { restoreScrollPosition(anchor); }); }
        function toggleSettingsWindow() { const settingsWindow = document.getElementById('settings-window'); const apiKeyInput = document.getElementById('api-key-input'); if (settingsWindow.classList.contains('open')) { saveSettingsData(); settingsWindow.classList.remove('open'); } else { settingsWindow.classList.add('open'); apiKeyInput.value = settings.apiKey || ''; if(document.getElementById(settings.selectedModel)) document.getElementById(settings.selectedModel).checked = true; apiKeyInput.focus(); document.querySelectorAll('.radio-wrapper').forEach(wrapper => { wrapper.addEventListener('click', function() { const input = this.querySelector('input[type="radio"]'); if (input && !input.checked) { input.checked = true; saveSettingsData(); } }); }); } }
        function saveSettingsData() { const apiKeyInput = document.getElementById('api-key-input'); const selectedModelInput = document.querySelector('input[name="ai-model"]:checked'); settings.apiKey = apiKeyInput.value.trim(); if(selectedModelInput) settings.selectedModel = selectedModelInput.value; saveSettings(); }
        function toggleAboutUs() { aboutUsActive = !aboutUsActive; const sidebarMain = document.querySelector('.sidebar-main'); const aboutUsContent = document.querySelector('.about-us-content'); const aboutUsButton = document.querySelector('.about-us-button'); aboutUsButton.classList.toggle('active', aboutUsActive); if (aboutUsActive) { sidebarMain.style.display = 'none'; aboutUsContent.style.display = 'flex'; } else { sidebarMain.style.display = 'block'; aboutUsContent.style.display = 'none'; } }
        function editMainChatTitle(chatId) { const chatTitleMain = document.getElementById('chat-title-main'); const currentTitle = chatTitleMain.textContent; chatTitleMain.innerHTML = `<input type="text" value="${currentTitle}" />`; const input = chatTitleMain.querySelector('input'); input.focus(); input.setSelectionRange(input.value.length, input.value.length); input.onblur = () => saveMainChatTitle(chatId, input.value); input.onkeypress = (e) => { if (e.key === 'Enter') saveMainChatTitle(chatId, input.value); }; }
        function saveMainChatTitle(chatId, newTitle) { const chatTitleMain = document.getElementById('chat-title-main'); const chat = chats.find(c => c.id === chatId); const isDuplicate = chats.some(c => c.id !== chatId && c.title === newTitle); if (isDuplicate) { chatTitleMain.textContent = chat.title; } else { const finalTitle = newTitle.trim() || `چت ${chatId}`; chatTitleMain.textContent = finalTitle; if (chat) { chat.title = finalTitle; saveChatsDebounced(); renderChatList(); } } }
        function editChatTitle(chatId, button) { const chatItem = button.closest('.chat-item'); const chatTitle = chatItem.querySelector('.chat-title'); const currentTitle = chatTitle.textContent; chatTitle.innerHTML = `<input type="text" value="${currentTitle}" />`; const input = chatTitle.querySelector('input'); input.focus(); input.setSelectionRange(input.value.length, input.value.length); input.addEventListener('blur', function() { saveChatTitle(chatId, chatItem, input.value); }); input.addEventListener('keypress', function(e) { if (e.key === 'Enter') saveChatTitle(chatId, chatItem, input.value); }); }
        function saveChatTitle(chatId, chatItem, newTitle) { const chatTitle = chatItem.querySelector('.chat-title'); const chat = chats.find(c => c.id === chatId); const isDuplicate = chats.some(c => c.id !== chatId && c.title === newTitle); if (isDuplicate) { chatTitle.textContent = chat.title; } else { const finalTitle = newTitle.trim() || `چت ${chatId}`; chatTitle.textContent = finalTitle; if (chat) { chat.title = finalTitle; saveChatsDebounced(); document.getElementById('chat-title-main').textContent = finalTitle; } } }
        function deleteChat(chatId, button) { const chatItem = button.closest('.chat-item'); if (chatItem.classList.contains('delete-pending')) { chats = chats.filter(chat => chat.id !== chatId); saveChatsDebounced(); renderChatList(); worker.postMessage({ type: 'delete-collection', payload: { chatId } }); if (activeGeneration && activeGeneration.chatId === chatId) { activeGeneration.controller.abort(); } if (currentChatId === chatId) { const chatArea = document.getElementById('chat-area'); const chatTitleMain = document.getElementById('chat-title-main'); chatArea.innerHTML = ''; if (chats.length === 0) chatTitleMain.textContent = ''; else { currentChatId = chats[chats.length - 1].id; loadChat(currentChatId); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); } } } else { document.querySelectorAll('.chat-item.delete-pending').forEach(item => { item.classList.remove('delete-pending'); item.style.border = ''; item.style.boxShadow = ''; }); chatItem.classList.add('delete-pending'); chatItem.style.border = '2px solid #d32f2f'; chatItem.style.boxShadow = 'inset 0 0 10px rgba(211, 47, 47, 0.5)'; } }
        function toggleMenu() { const sidebar = document.getElementById('sidebar'); const menuButton = document.querySelector('.menu-button'); const isOpen = sidebar.classList.contains('open'); sidebar.classList.toggle('open'); menuButton.classList.toggle('hidden', !isOpen); if (!isOpen && aboutUsActive) toggleAboutUs(); }
        function toggleAiMessageMenu(event, buttonElement) { event.stopPropagation(); const menu = buttonElement.nextElementSibling; const isCurrentlyShown = menu.classList.contains('show'); document.querySelectorAll('.ai-message-context-menu.show').forEach(openMenu => { openMenu.classList.remove('show'); }); if (!isCurrentlyShown) { menu.classList.add('show'); } }
        function openPromptModal() { let currentChat = chats.find(c => c.id === currentChatId); if (!currentChat) { createNewChat(); currentChat = chats.find(c => c.id === currentChatId); } const modal = document.getElementById('prompt-modal'); const textarea = document.getElementById('prompt-modal-textarea'); textarea.value = currentChat.prompt || ''; modal.style.display = 'flex'; textarea.focus(); }
        function closePromptModal() { document.getElementById('prompt-modal').style.display = 'none'; }
        function savePrompt() { const currentChat = chats.find(c => c.id === currentChatId); if(currentChat) { const textarea = document.getElementById('prompt-modal-textarea'); currentChat.prompt = textarea.value.trim(); saveChatsDebounced(); showNotification('پرامپت ذخیره شد.', 'success'); } closePromptModal(); }
        function openRegenerateModal(messageId) { currentRegenerateMessageId = messageId; const modal = document.getElementById('regenerate-modal'); const textarea = document.getElementById('regenerate-modal-textarea'); textarea.value = ''; modal.style.display = 'flex'; textarea.focus(); }
        function closeRegenerateModal() { document.getElementById('regenerate-modal').style.display = 'none'; currentRegenerateMessageId = null; }
        function confirmRegeneration() { const textarea = document.getElementById('regenerate-modal-textarea'); const instruction = textarea.value.trim(); if (instruction) { regenerateStory(instruction); } else { showNotification('لطفا یک دستورالعمل برای بازنویسی وارد کنید.', 'error'); } closeRegenerateModal(); }
        document.addEventListener('click', function(e) { const sidebar = document.getElementById('sidebar'); const menuButton = document.querySelector('.menu-button'); const settingsWindow = document.getElementById('settings-window'); const settingsButton = document.querySelector('.settings-button'); const chatTitleMain = document.getElementById('chat-title-main'); const isSidebarOpen = sidebar.classList.contains('open'); const isSettingsWindowOpen = settingsWindow.classList.contains('open'); if (isSidebarOpen && !sidebar.contains(e.target) && !menuButton.contains(e.target)) { sidebar.classList.remove('open'); menuButton.classList.remove('hidden'); if (aboutUsActive) toggleAboutUs(); } if (isSettingsWindowOpen && !settingsWindow.contains(e.target) && !settingsButton.contains(e.target)) { saveSettingsData(); settingsWindow.classList.remove('open'); } document.querySelectorAll('.chat-item.delete-pending').forEach(item => { if (!item.contains(e.target)) { item.classList.remove('delete-pending'); item.style.border = ''; item.style.boxShadow = ''; } }); if (chatTitleMain.querySelector('input') && !chatTitleMain.contains(e.target)) { const input = chatTitleMain.querySelector('input'); saveMainChatTitle(currentChatId, input.value); } document.querySelectorAll('.ai-message-context-menu.show').forEach(openMenu => { if (!openMenu.closest('.message').contains(e.target)) { openMenu.classList.remove('show'); } }); });
        document.addEventListener('keydown', function(e) { if (e.ctrlKey && e.key === 'Enter') continueStory(); });
        document.addEventListener('DOMContentLoaded', () => { renderChatList(); if (chats.length > 0) { loadChat(currentChatId); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); } document.getElementById('confirm-prompt-btn').onclick = savePrompt; document.getElementById('cancel-prompt-btn').onclick = closePromptModal; document.getElementById('prompt-modal').onclick = (e) => { if (e.target.id === 'prompt-modal') closePromptModal(); }; document.getElementById('confirm-regenerate-btn').onclick = confirmRegeneration; document.getElementById('cancel-regenerate-btn').onclick = closeRegenerateModal; document.getElementById('regenerate-modal').onclick = (e) => { if (e.target.id === 'regenerate-modal') closeRegenerateModal(); }; });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(registration => { console.log('Nora PWA ServiceWorker registered successfully.'); }).catch(err => { console.error('ServiceWorker registration failed: ', err); }); }); }
    </script>
</body>
</html>
