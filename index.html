<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nora - AI Writing Assistant</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3a3a3a">
    <style>
        @font-face { font-family: 'Iran Yekan'; src: url('https://raw.githubusercontent.com/AsterLywin/Nora/main/Fonts/Iran%20Yekan%20Medium.ttf') format('truetype'); font-weight: bold; font-style: normal; }
        @font-face { font-family: 'San Francisco Bold'; src: url('https://raw.githubusercontent.com/AsterLywin/Nora/main/Fonts/San%20Francisco%20bold.ttf') format('truetype'); font-weight: bold; font-style: normal; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; font-family: 'Iran Yekan', sans-serif; background-color: #161b22; color: #c9d1d9; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        textarea, input { -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text; }
        .main { width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .main.reading-mode { background-color: #202020; }
        .top-bar { display: flex; align-items: center; padding: 5px 15px; position: absolute; top: 0; left: 0; right: 0; height: 30px; background-color: #161b22; border-bottom: 2px solid #484f58; z-index: 15; box-sizing: content-box; }
        .chat-area { flex: 1; width: 100%; height: 100%; padding: 20px; padding-top: 72px; padding-bottom: 80px; overflow-y: auto; scroll-padding-top: 72px; display: flex; flex-direction: column; box-sizing: border-box; }
        .message-group { margin-bottom: 20px; display: flex; flex-direction: column; width: 100%; position: relative; }
        .message-group:not(:last-child)::after { content: ''; display: block; width: 95%; height: 2px; background-color: #484f58; margin: 10px auto 0; }
        .message { margin-bottom: 5px; line-height: 1.5; position: relative; display: block; width: fit-content; }
        .ai-message { width: 80%; margin: 0 auto 5px; font-family: 'San Francisco Bold', sans-serif; font-size: 16px; white-space: pre-wrap; box-sizing: border-box; }
        .ai-message.rtl { text-align: right; }
        .ai-message.ltr { text-align: left; }
        .ai-message.loading::after { content: ''; display: inline-block; width: 12px; height: 12px; border: 2px solid #2563eb; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
        .loading-timer { margin-right: 5px; font-weight: bold; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; pointer-events: none; }
        .input-wrapper { display: flex; justify-content: flex-start; padding: 15px 20px; }
        .input-area .send-button { width: 50px; height: 50px; background-color: #2563eb; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25); transition: background-color 0.2s; pointer-events: auto; }
        .input-area .send-button:hover { background-color: #4a8bff; }
        .send-button svg { width: 24px; height: 24px; }
        .input-area .send-button:disabled { background-color: #6b7280; cursor: not-allowed; }
        .menu-button { position: static; background-color: #2563eb; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; }
        .menu-button.hidden { opacity: 0; pointer-events: none; }
        .menu-button:hover { background-color: #4a8bff; }
        .menu-button svg { width: 20px; height: 20px; transform: rotate(180deg); }
        .chat-title-main { position: static; flex-grow: 1; text-align: right; margin: 0 15px; font-size: 16px; font-family: 'Iran Yekan', sans-serif; color: #c9d1d9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-title-main input { width: 100%; padding: 5px; border: none; border-radius: 5px; outline: none; font-size: 14px; direction: rtl; font-family: 'Iran Yekan', sans-serif; background-color: #30363d; color: #ffffff; }
        .reading-mode-button { position: static; width: 30px; height: 30px; background-color: #2563eb; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .reading-mode-button:hover { background-color: #4a8bff; }
        .reading-mode-button.active { opacity: 0.6; }
        .reading-mode-button svg { width: 20px; height: 20px; }
        .sidebar { position: absolute; top: 0; right: -100%; width: 50%; height: 100%; padding: 15px; border-left: 1px solid #30363d; transition: right 0.3s ease, visibility 0.3s; visibility: hidden; z-index: 20; background-color: #161b22; }
        .sidebar.open { right: 0; visibility: visible; }
        .sidebar h2 { font-size: 16px; margin: 10px 0 15px; font-weight: normal; color: #c9d1d9; }
        .sidebar-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(35px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .sidebar-actions button { width: 100%; height: 35px; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sidebar-actions .prompt-button,
        .sidebar-actions .upload-button,
        .sidebar-actions .new-chat-button,
        .sidebar-actions .settings-button,
        .sidebar-actions .about-us-button { background-color: #2563eb; }
        .sidebar-actions .prompt-button:hover,
        .sidebar-actions .upload-button:hover,
        .sidebar-actions .new-chat-button:hover,
        .sidebar-actions .settings-button:hover,
        .sidebar-actions .about-us-button:hover { background-color: #4a8bff; }
        .sidebar-actions .prompt-button svg,
        .sidebar-actions .upload-button svg { stroke: #ffffff; }
        .sidebar-actions .clear-chat-button { background-color: #d32f2f; }
        .sidebar-actions .clear-chat-button:hover { background-color: #f44336; }
        .sidebar-actions .about-us-button.active { opacity: 0.6; }
        .sidebar-actions button svg { width: 20px; height: 20px; }
        .settings-window { width: 100%; max-width: 180px; margin: 0 auto 15px; padding: 8px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); border: 1px solid #30363d; display: none; background-color: #21262d; opacity: 0; }
        .settings-window.open { display: block; opacity: 1; }
        .settings-container { display: flex; flex-direction: column; gap: 15px; }
        .settings-window input { width: 100%; padding: 8px; border: none; border-radius: 5px; outline: none; font-size: 14px; font-family: 'Iran Yekan', sans-serif; text-align: center; background-color: #30363d; color: #ffffff; box-sizing: border-box; }
        .ai-model-selection { display: flex; flex-direction: column; gap: 10px; }
        .ai-name { font-size: 16px; margin: 0; color: #c9d1d9; }
        .model-option { display: flex; flex-direction: column; }
        .radio-wrapper { display: flex; align-items: center; gap: 8px; position: relative; cursor: pointer; }
        .radio-wrapper input[type="radio"] { display: none; }
        .radio-wrapper label::before { content: ''; width: 16px; height: 16px; border: 2px solid #ffffff; border-radius: 50%; display: inline-block; background-color: transparent; margin-left: 8px; }
        .radio-wrapper input[type="radio"]:checked + label::before { background-color: #2563eb; }
        .radio-wrapper label { font-size: 14px; cursor: pointer; color: #c9d1d9; }
        .radio-wrapper input[type="radio"]:checked + label { color: #2563eb; }
        .model-description { font-size: 12px; color: #8b949e; margin: 5px 0 0 24px; text-align: right; }
        .model-separator { border: 0; height: 1px; background-color: #30363d; margin: 5px 0; }
        .search-bar { margin: 0 0 20px; }
        .search-bar input { width: 100%; padding: 8px; border: none; border-radius: 5px; outline: none; font-size: 14px; font-family: 'Iran Yekan', sans-serif; background-color: #21262d; color: #ffffff; box-sizing: border-box; }
        .chat-item { display: flex; align-items: center; padding: 8px 12px; margin-bottom: 8px; border-radius: 8px; background-color: #21262d; cursor: move; user-select: none; }
        .chat-item.hidden { display: none; }
        .chat-item:hover { background-color: #30363d; }
        .chat-item.active { border: 2px solid #2563eb; }
        .chat-item.delete-pending { border: 2px solid #d32f2f !important; box-shadow: inset 0 0 10px rgba(211, 47, 47, 0.5); }
        .chat-item.dragging { opacity: 0.5; }
        .chat-title { flex: 1; font-size: 14px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #c9d1d9; }
        .chat-actions { display: flex; gap: 8px; }
        .chat-actions button { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        .chat-actions button:hover { opacity: 0.7; }
        .chat-actions button svg { width: 16px; height: 16px; }
        .chat-title input { width: 100%; padding: 5px; border: none; border-radius: 5px; outline: none; font-size: 14px; direction: rtl; font-family: 'Iran Yekan', sans-serif; background-color: #30363d; color: #ffffff; }
        .about-us-content { display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #21262d; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); margin: 20px auto; max-width: 100%; width: 100%; box-sizing: border-box; text-align: center; }
        .about-us-title { font-size: 18px; font-weight: bold; color: #ffffff; margin-bottom: 15px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        .about-us-text { font-size: 14px; color: #c9d1d9; line-height: 1.6; margin-bottom: 20px; padding: 0 10px; text-align: right; width: 100%; box-sizing: border-box; }
        .about-us-links { display: flex; flex-direction: column; align-items: stretch; gap: 10px; width: 100%; }
        .telegram-link, .github-link { display: flex; align-items: center; justify-content: center; padding: 12px 16px; color: #ffffff; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: bold; transition: background-color 0.3s, transform 0.2s; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); white-space: nowrap; }
        .telegram-link:hover, .github-link:hover { transform: translateY(-2px); }
        .telegram-link { background-color: #0088cc; }
        .telegram-link:hover { background-color: #00aaff; }
        .github-link { background-color: #333; }
        .github-link:hover { background-color: #555; }
        .telegram-icon, .github-icon { width: 20px; height: 20px; margin-right: 8px; }
        .github-icon { fill: white; }
        .ai-message-actions { position: absolute; top: 5px; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; }
        .ai-message.rtl .ai-message-actions { left: -45px; }
        .ai-message.ltr .ai-message-actions { right: -45px; }
        .message:hover .ai-message-actions, .ai-message.error .ai-message-actions { opacity: 1; pointer-events: auto; }
        .ai-message-actions .options-button { width: 30px; height: 30px; border-radius: 50%; background-color: #1e40af; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ai-message-actions .options-button:hover { background-color: #2563eb; }
        .ai-message-actions .options-button svg { width: 20px; height: 20px; }
        .ai-message-context-menu { position: absolute; display: none; width: fit-content; white-space: nowrap; background-color: #30363d; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); z-index: 25; padding: 5px; top: 35px; }
        .ai-message.rtl .ai-message-context-menu { left: 0; }
        .ai-message.ltr .ai-message-context-menu { right: 0; }
        .ai-message-context-menu.show { display: block; }
        .ai-message-context-menu button { width: 100%; padding: 8px 12px; background: none; border: none; color: #c9d1d9; cursor: pointer; text-align: right; font-family: 'Iran Yekan', sans-serif; font-size: 14px; border-radius: 5px; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .ai-message-context-menu button:hover { background-color: #484f58; }
        .ai-message-context-menu button.regenerate-action { color: #38bdf8; }
        .ai-message-context-menu button.regenerate-action:hover { background-color: rgba(56, 189, 248, 0.2); }
        .ai-message-context-menu button svg { width: 16px; height: 16px; fill: none; }
        .ai-message-context-menu button.regenerate-action .regenerate-svg { stroke: #38bdf8; }
        .main.reading-mode .top-bar { background-color: #202020; }
        .main.reading-mode .chat-area { padding: 0; padding-top: 62px; scroll-padding-top: 62px; }
        .main.reading-mode .menu-button, .main.reading-mode .ai-message-actions, .main.reading-mode .input-area { display: none !important; }
        .main.reading-mode .ai-message.rtl, .main.reading-mode .ai-message.ltr { width: 90%; margin: 0 auto 10px; padding: 10px 15px; color: #b7b7b7; text-align: right; }
        #notification-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast-notification { font-family: 'Iran Yekan', sans-serif; padding: 10px 20px; border-radius: 8px; color: #ffffff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-notification.success { background-color: #28a745; }
        .toast-notification.error { background-color: #d32f2f; }
        .toast-notification.info { background-color: #17a2b8; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .modal-content { background-color: #21262d; padding: 20px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; font-family: 'Iran Yekan', sans-serif; }
        .modal-title { font-size: 18px; color: #c9d1d9; margin: 0; text-align: center; }
        .modal-description { font-size: 13px; color: #8b949e; margin: 0; text-align: center; line-height: 1.5; }
        .modal-textarea { width: 100%; min-height: 150px; padding: 10px; border: 1px solid #30363d; border-radius: 8px; outline: none; resize: vertical; font-size: 14px; font-family: 'Iran Yekan', sans-serif; background-color: #161b22; color: #c9d1d9; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-button { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background-color 0.2s; }
        .modal-button.confirm { background-color: #2563eb; color: #ffffff; }
        .modal-button.confirm:hover { background-color: #4a8bff; }
        .modal-button.cancel { background-color: #484f58; color: #c9d1d9; }
        .modal-button.cancel:hover { background-color: #6e7681; }
    </style>
</head>
<body>
    <div class="main" id="main">
        <div class="top-bar">
            <button class="menu-button" onclick="toggleMenu()" title="منو">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 6L21 6.00078M8 12L21 12.0008M8 18L21 18.0007M3 6.5H4V5.5H3V6.5ZM3 12.5H4V11.5H3V12.5ZM3 18.5H4V17.5H3V18.5Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="chat-title-main" id="chat-title-main"></div>
            <button class="reading-mode-button" id="reading-mode-button" onclick="toggleReadingMode()" title="حالت مطالعه">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.99902 3L20.999 21M9.8433 9.91364C9.32066 10.4536 8.99902 11.1892 8.99902 12C8.99902 13.6569 10.3422 15 11.999 15C12.8215 15 13.5667 14.669 14.1086 14.133M6.49902 6.64715C4.59972 7.90034 3.15305 9.78394 2.45703 12C3.73128 16.0571 7.52159 19 11.9992 19C13.9881 19 15.8414 18.4194 17.3988 17.4184M10.999 5.04939C11.328 5.01673 11.6617 5 11.9992 5C16.4769 5 20.2672 7.94291 21.5414 12C21.2607 12.894 20.8577 13.7338 20.3522 14.5" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <div class="chat-area" id="chat-area"></div>
        
        <div class="input-area">
            <div class="input-wrapper">
                <button class="send-button" onclick="continueStory()" title="شروع / ادامه داستان (Ctrl+Enter)" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.5003 12H5.41872M5.24634 12.7972L4.24158 15.7986C3.69128 17.4424 3.41613 18.2643 3.61359 18.7704C3.78506 19.21 4.15335 19.5432 4.6078 19.6701C5.13111 19.8161 5.92151 19.4604 7.50231 18.7491L17.6367 14.1886C19.1797 13.4942 19.9512 13.1471 20.1896 12.6648C20.3968 12.2458 20.3968 11.7541 20.1896 11.3351C19.9512 10.8529 19.1797 10.5057 17.6367 9.81135L7.48483 5.24303C5.90879 4.53382 5.12078 4.17921 4.59799 4.32468C4.14397 4.45101 3.77572 4.78336 3.60365 5.22209C3.40551 5.72728 3.67772 6.54741 4.22215 8.18767L5.24829 11.2793C5.34179 11.561 5.38855 11.7019 5.407 11.8459C5.42338 11.9738 5.42321 12.1032 5.40651 12.231C5.38768 12.375 5.34057 12.5157 5.24634 12.7972Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-content" id="sidebar-content">
                <div class="sidebar-main">
                    <div class="sidebar-actions">
                        <button class="prompt-button" onclick="openPromptModal()" title="ویرایش پرامپت">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                            </svg>
                        </button>
                        <button class="upload-button" onclick="triggerUpload()" title="آپلود کتاب">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </button>
                        <button class="about-us-button" onclick="toggleAboutUs()" title="درباره ما">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="settings-button" onclick="toggleSettingsWindow()" title="تنظیمات">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12.9046 3.06005C12.6988 3 12.4659 3 12 3C11.5341 3 11.3012 3 11.0954 3.06005C10.7942 3.14794 10.5281 3.32808 10.3346 3.57511C10.2024 3.74388 10.1159 3.96016 9.94291 4.39272C9.69419 5.01452 9.00393 5.33471 8.36857 5.123L7.79779 4.93281C7.3929 4.79785 7.19045 4.73036 6.99196 4.7188C6.70039 4.70181 6.4102 4.77032 6.15701 4.9159C5.98465 5.01501 5.83376 5.16591 5.53197 5.4677C5.21122 5.78845 5.05084 5.94882 4.94896 6.13189C4.79927 6.40084 4.73595 6.70934 4.76759 7.01551C4.78912 7.2239 4.87335 7.43449 5.04182 7.85566C5.30565 8.51523 5.05184 9.26878 4.44272 9.63433L4.16521 9.80087C3.74031 10.0558 3.52786 10.1833 3.37354 10.3588C3.23698 10.5141 3.13401 10.696 3.07109 10.893C3 11.1156 3 11.3658 3 11.8663C3 12.4589 3 12.7551 3.09462 13.0088C3.17823 13.2329 3.31422 13.4337 3.49124 13.5946C3.69158 13.7766 3.96395 13.8856 4.50866 14.1035C5.06534 14.3261 5.35196 14.9441 5.16236 15.5129L4.94721 16.1584C4.79819 16.6054 4.72367 16.829 4.7169 17.0486C4.70875 17.3127 4.77049 17.5742 4.89587 17.8067C5.00015 18.0002 5.16678 18.1668 5.5 18.5C5.83323 18.8332 5.99985 18.9998 6.19325 19.1041C6.4258 19.2295 6.68733 19.2913 6.9514 19.2831C7.17102 19.2763 7.39456 19.2018 7.84164 19.0528L8.36862 18.8771C9.00393 18.6654 9.6942 18.9855 9.94291 19.6073C10.1159 20.0398 10.2024 20.2561 10.3346 20.4249C10.5281 20.6719 10.7942 20.8521 11.0954 20.94C11.3012 21 11.5341 21 12 21C12.4659 21 12.6988 21 12.9046 20.94C13.2058 20.8521 13.4719 20.6719 13.6654 20.4249C13.7976 20.2561 13.8841 20.0398 14.0571 19.6073C14.3058 18.9855 14.9961 18.6654 15.6313 18.8773L16.1579 19.0529C16.605 19.2019 16.8286 19.2764 17.0482 19.2832C17.3123 19.2913 17.5738 19.2296 17.8063 19.1042C17.9997 18.9999 18.1664 18.8333 18.4996 18.5001C18.8328 18.1669 18.9994 18.0002 19.1037 17.8068C19.2291 17.5743 19.2908 17.3127 19.2827 17.0487C19.2759 16.8291 19.2014 16.6055 19.0524 16.1584L18.8374 15.5134C18.6477 14.9444 18.9344 14.3262 19.4913 14.1035C20.036 13.8856 20.3084 13.7766 20.5088 13.5946C20.6858 13.4337 20.8218 13.2329 20.9054 13.0088C21 12.7551 21 12.4589 21 11.8663C21 11.3658 21 11.1156 20.9289 10.893C20.866 10.696 20.763 10.5141 20.6265 10.3588C20.4721 10.1833 20.2597 10.0558 19.8348 9.80087L19.5569 9.63416C18.9478 9.26867 18.6939 8.51514 18.9578 7.85558C19.1262 7.43443 19.2105 7.22383 19.232 7.01543C19.2636 6.70926 19.2003 6.40077 19.0506 6.13181C18.9487 5.94875 18.7884 5.78837 18.4676 5.46762C18.1658 5.16584 18.0149 5.01494 17.8426 4.91583C17.5894 4.77024 17.2992 4.70174 17.0076 4.71872C16.8091 4.73029 16.6067 4.79777 16.2018 4.93273L15.6314 5.12287C14.9961 5.33464 14.3058 5.0145 14.0571 4.39272C13.8841 3.96016 13.7976 3.74388 13.6654 3.57511C13.4719 3.32808 13.2058 3.14794 12.9046 3.06005Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="new-chat-button" onclick="createNewChat()" title="چت جدید">
                             <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                               <path d="M10 12H14M12 10V14M19.9592 15H16.6C16.0399 15 15.7599 15 15.546 15.109C15.3578 15.2049 15.2049 15.3578 15.109 15.546C15 15.7599 15 16.0399 15 16.6V19.9592M20 14.1031V7.2C20 6.07989 20 5.51984 19.782 5.09202C19.5903 4.71569 19.2843 4.40973 18.908 4.21799C18.4802 4 17.9201 4 16.8 4H7.2C6.0799 4 5.51984 4 5.09202 4.21799C4.71569 4.40973 4.40973 4.71569 4.21799 5.09202C4 5.51984 4 6.0799 4 7.2V16.8C4 17.9201 4 18.4802 4.21799 18.908C4.40973 19.2843 4.71569 19.5903 5.09202 19.782C5.51984 20 6.0799 20 7.2 20H14.1031C14.5923 20 14.8369 20 15.067 19.9447C15.2711 19.8957 15.4662 19.8149 15.6451 19.7053C15.847 19.5816 16.0199 19.4086 16.3658 19.0627L19.0627 16.3658C19.4086 16.0199 19.5816 15.847 19.7053 15.6451C19.8149 15.4662 19.8957 15.2711 19.9447 15.067C20 14.8369 20 14.5923 20 14.1031Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="clear-chat-button" onclick="clearChat()" title="پاک کردن تاریخچه چت">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M18 6V16.2C18 17.8802 18 18.7202 17.673 19.362C17.3854 19.9265 16.9265 20.3854 16.362 20.673C15.7202 21 14.8802 21 13.2 21H10.8C9.11984 21 8.27976 21 7.63803 20.673C7.07354 20.3854 6.6146 19.9265 6.32698 19.362C6 18.7202 6 17.8802 6 16.2V6M14 10V17M10 10V17" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="settings-window" id="settings-window">
                        <div class="settings-container">
                            <input type="text" id="api-key-input" placeholder="کلید API خود را اینجا وارد کنید...">
                            <div class="ai-model-selection">
                                <h3 class="ai-name">Gemini</h3>
                                <div class="model-option">
                                    <div class="radio-wrapper">
                                        <input type="radio" name="ai-model" id="gemini-2.5-pro" value="gemini-2.5-pro">
                                        <label for="gemini-2.5-pro">gemini-2.5-pro</label>
                                    </div>
                                    <p class="model-description">بالاترین کیفیت، کندترین سرعت (۱ تا ۵ دقیقه).</p>
                                </div>
                                <hr class="model-separator">
                                <div class="model-option">
                                    <div class="radio-wrapper">
                                        <input type="radio" name="ai-model" id="gemini-2.5-flash" value="gemini-2.5-flash">
                                        <label for="gemini-2.5-flash">gemini-2.5-flash</label>
                                    </div>
                                    <p class="model-description">تعادل بین سرعت و دقت، مناسب اکثر سناریوها.</p>
                                </div>
                                <hr class="model-separator">
                                <div class="model-option">
                                    <div class="radio-wrapper">
                                        <input type="radio" name="ai-model" id="gemini-2.0-flash" value="gemini-2.0-flash" checked>
                                        <label for="gemini-2.0-flash">gemini-2.0-flash</label>
                                    </div>
                                     <p class="model-description">سریع‌ترین مدل، کیفیت مناسب.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-bar">
                        <input type="text" placeholder="جستجو در کتاب‌ها..." oninput="searchChats(this.value)">
                    </div>
                    <h2>کتابخانه</h2>
                    <div id="chat-list"></div>
                </div>
                <div class="about-us-content" style="display: none;">
                    <h2 class="about-us-title">درباره ما</h2>
                    <p class="about-us-text">
                        «Nora» دستیار نویسندگی خلاق شماست. با استفاده از یک حافظه هوشمند و مقیاس‌پذیر، نورا به شما کمک می‌کند تا داستان‌های بلند و پیچیده بنویسید، بدون آنکه نگران فراموش شدن جزئیات و خطوط داستانی باشید.
                        <br><br>
                        این یک پروژه اجتماعی است! برای اطلاع از آخرین اخبار و به‌روزرسانی‌ها به کانال تلگرام ما بپیوندید و برای مشارکت در توسعه، مشاهده کد منبع یا گزارش مشکلات از پروژه گیت‌هاب ما دیدن کنید.
                    </p>
                    <div class="about-us-links">
                        <a href="https://t.me/Nora_App" target="_blank" class="telegram-link">
                            <span> کانال تلگرام</span>
                            <svg class="telegram-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                               <path d="M2.99997 9.80005L21 3.00005L14.2 21L10.2 13.8L2.99997 9.80005Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                               <path d="M21 3L10.2 13.8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                        <a href="https://github.com/AsterLywin/Nora-Novelist" target="_blank" class="github-link">
                            <span>پروژه در گیت‌هاب</span>
                            <svg class="github-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="prompt-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">پرامپت اصلی داستان</h3>
            <p class="modal-description">ایده اصلی، ژانر، شخصیت‌ها و خط کلی داستان خود را در اینجا وارد کنید. این پرامپت به عنوان راهنمای اصلی برای هوش مصنوعی عمل خواهد کرد.</p>
            <textarea id="prompt-modal-textarea" class="modal-textarea" placeholder="مثال: یک داستان فانتزی تاریک درباره آخرین بازمانده یک خاندان سلطنتی که در تلاش برای بازپس‌گیری تاج و تخت خود در دنیایی است که توسط هیولاها تسخیر شده..."></textarea>
            <div class="modal-actions">
                <button id="cancel-prompt-btn" class="modal-button cancel">لغو</button>
                <button id="confirm-prompt-btn" class="modal-button confirm">تایید</button>
            </div>
        </div>
    </div>

    <div id="regenerate-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">اصلاح و بازنویسی</h3>
            <p class="modal-description">دستور خود برای اصلاح این بخش از داستان را وارد کنید. می‌توانید درخواست تغییر لحن، اصلاح کلمات یا تغییر یک رویداد خاص را بدهید.</p>
            <textarea id="regenerate-modal-textarea" class="modal-textarea" placeholder="مثال: شمشیر یخی با خودکشی شخصیت اصلی از بین نرفت، بلکه به قطعات درخشانی تبدیل شد که در هوا معلق ماندند..."></textarea>
            <div class="modal-actions">
                <button id="cancel-regenerate-btn" class="modal-button cancel">لغو</button>
                <button id="confirm-regenerate-btn" class="modal-button confirm">تایید و بازنویسی</button>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>
    
    <input type="file" id="import-file-input" style="display: none;" accept=".nora,.json">

    <script>
        let worker;
        if (window.Worker) {
            worker = new Worker('./worker.js', { type: 'module' }); 

            const isFirstVisit = !localStorage.getItem('nora_visited_before');
            if (isFirstVisit) {
                showNotification('به نورا خوش آمدید! در حال آماده‌سازی اولیه...', 'info');
                localStorage.setItem('nora_visited_before', 'true');
            } else {
                showNotification('دستیار هوشمند در حال بارگذاری...', 'info');
            }
            
            worker.onmessage = function(e) {
                const { type, payload } = e.data;
                if (type === 'log' || type === 'error') {
                    console[type]('[Worker]', payload);
                } 
                else if (type === 'ready') {
                    showNotification('دستیار هوشمند آماده است.', 'success');
                    document.querySelector('.send-button').disabled = false;
                } 
                else if (type === 'context-retrieved') {
                    handleContextRetrieved(payload);
                } else if (type === 'add-to-memory-done') {
                    console.log(`[Worker] Content for message ${payload.messageId} added to memory.`);
                }
            };
            
            worker.onerror = function(e) {
                e.preventDefault(); 
                console.error(`[Worker] Unhandled Error: Line ${e.lineno} in ${e.filename}: ${e.message}`, e);
                alert(`خطای بحرانی در بارگذاری دستیار:\n\nفایل: ${e.filename}\nشماره خط: ${e.lineno}\n\nپیام: ${e.message}\n\nلطفا از این پیام اسکرین‌شات بگیرید.`);
                showNotification('خطای بحرانی در بارگذاری دستیار.', 'error');
                document.querySelector('.send-button').disabled = false;
            };

        } else {
            alert('مرورگر شما از Web Workers پشتیبانی نمی‌کند. عملکرد برنامه ممکن است مختل شود.');
        }

        let chats = [];
        try {
            chats = JSON.parse(localStorage.getItem('nora_writer_chats')) || [];
        } catch (e) {
            console.error("Could not parse chats from localStorage:", e);
            chats = [];
        }
        
        chats.forEach(chat => {
            chat.messages = chat.messages.filter(message => message.text !== 'در حال پردازش...');
        });
        
        let currentChatId = chats.length > 0 ? chats[chats.length - 1].id : 0;
        let readingMode = false;
        let draggedChat = null;
        
        let settings = {};
        try {
            settings = JSON.parse(localStorage.getItem('nora_writer_settings')) || { apiKey: '', selectedModel: 'gemini-2.0-flash' };
        } catch (e) {
            console.error("Could not parse settings from localStorage:", e);
            settings = { apiKey: '', selectedModel: 'gemini-2.0-flash' };
        }
        
        let isCreatingChat = false;
        let aboutUsActive = false;
        let messageIdCounter = chats.reduce((max, chat) => { const maxChatId = chat.messages.reduce((m, msg) => Math.max(m, msg.id || 0), 0); return Math.max(max, maxChatId); }, 0) + 1;
        let isGenerating = false;
        let activeGeneration = null;
        let saveTimeout = null;
        let currentRegenerateMessageId = null;

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `toast-notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });

            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => {
                    if (notification.parentElement === container) {
                         container.removeChild(notification);
                    }
                }, { once: true });
            }, 3000);
        }

        async function _callGeminiAPI(fullPrompt, apiKey, modelName, signal) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };
            const response = await fetch(apiUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload), signal });
            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData?.error?.message || `خطای ناشناخته با کد ${response.status}`;
                switch (response.status) {
                    case 400: throw new Error("درخواست ارسال شده به مدل هوش مصنوعی ناقص یا اشتباه است.");
                    case 403: throw new Error("کلید API وارد شده نامعتبر است یا دسترسی لازم را ندارد.");
                    case 429: throw new Error("تعداد درخواست‌ها به سرور هوش مصنوعی بیش از حد مجاز بوده است.");
                    case 500: throw new Error("یک خطای داخلی در سرور هوش مصنوعی رخ داده است.");
                    case 503: throw new Error("سرویس هوش مصنوعی در حال حاضر در دسترس نیست.");
                    default: throw new Error(`خطای API: ${errorMessage}`);
                }
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0].finishReason === 'SAFETY') {
                throw new Error("تولید متن به دلیل فعال شدن فیلترهای ایمنی گوگل متوقف شد.");
            }
            const generatedText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!generatedText) throw new Error("پاسخ دریافتی از API خالی یا نامعتبر است.");
            return generatedText;
        }
        
        async function handleContextRetrieved(payload) {
            const { context, messageId, regenerationInstruction } = payload;
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!currentChat || !activeGeneration || activeGeneration.messageId !== messageId) return;

            const aiMessageElement = activeGeneration.messageGroup.querySelector('.ai-message');
            aiMessageElement.firstChild.textContent = 'در حال نوشتن داستان...';
            
            let fullPrompt = `${currentChat.prompt}\n\n`;

            if (context && context.length > 0) {
                 fullPrompt += `## خلاصه و بخش‌های مرتبط قبلی داستان:\n${context}\n\n`;
            }

            if (currentChat.messages.length > 1) {
                const lastMessageText = currentChat.messages[currentChat.messages.length - 2].text;
                fullPrompt += `## آخرین بخش نوشته شده از داستان:\n${lastMessageText}\n\n`;
            }
            
            if(regenerationInstruction){
                fullPrompt += `## دستورالعمل اصلاحی:\n${regenerationInstruction}\n\n## وظیفه:\nبر اساس دستورالعمل بالا، بخش آخر داستان را بازنویسی کن.\n`;
            } else if (currentChat.messages.length <= 1) {
                 fullPrompt += `## وظیفه:\nبر اساس پرامپت اصلی، بخش اول این داستان را بنویس.\n`;
            } else {
                 fullPrompt += `## وظیفه:\nادامه داستان را بنویس.\n`;
            }

            try {
                const generatedText = await _callGeminiAPI(fullPrompt, settings.apiKey, settings.selectedModel, activeGeneration.controller.signal);
                
                const messageIndex = currentChat.messages.findIndex(m => m.id === messageId);
                if (messageIndex !== -1) {
                    currentChat.messages[messageIndex].text = generatedText;
                }
                saveChatsDebounced();

                const directionClass = isRTL(generatedText) ? 'rtl' : 'ltr';
                aiMessageElement.className = `message ai-message ${directionClass}`;
                aiMessageElement.innerHTML = '';
                const messageBdi = document.createElement('bdi');
                messageBdi.textContent = generatedText;
                aiMessageElement.appendChild(messageBdi);
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'ai-message-actions';
                actionsDiv.innerHTML = `<button class="options-button" onclick="toggleAiMessageMenu(event, this)"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><div class="ai-message-context-menu"><button class="regenerate-action" onclick="openRegenerateModal(${messageId})" title="اصلاح و بازنویسی"><svg class="regenerate-svg" viewBox="0 0 24 24" width="18" height="18"><path d="M23 4v6h-6" stroke-width="2"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" stroke-width="2"></path></svg><span>اصلاح و بازنویسی</span></button></div>`;
                aiMessageElement.appendChild(actionsDiv);

                worker.postMessage({ type: 'add-to-memory', payload: { chatId: currentChatId, messageId: messageId, text: generatedText } });

            } catch(error) {
                handleGenerationError(error, aiMessageElement, messageId);
            } finally {
                clearInterval(activeGeneration.timerInterval);
                isGenerating = false;
                activeGeneration = null;
                document.querySelector('.send-button').disabled = false;
            }
        }
        
        function handleGenerationError(error, aiMessageElement, messageId) {
             if (error.name === 'AbortError') {
                console.log("Generation aborted by user.");
                return;
            }
            console.error("Generation failed:", error);
            aiMessageElement.className = 'message ai-message rtl error';
            aiMessageElement.innerHTML = '';
            const errorMessageBdi = document.createElement('bdi');
            errorMessageBdi.textContent = `خطا: ${error.message}`;
            aiMessageElement.appendChild(errorMessageBdi);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'ai-message-actions';
            actionsDiv.innerHTML = `<button class="options-button" onclick="toggleAiMessageMenu(event, this)"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><div class="ai-message-context-menu"><button class="regenerate-action" onclick="openRegenerateModal(${messageId})" title="اصلاح و بازنویسی"><svg class="regenerate-svg" viewBox="0 0 24 24" width="18" height="18"><path d="M23 4v6h-6" stroke-width="2"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" stroke-width="2"></path></svg><span>اصلاح و بازنویسی</span></button></div>`;
            aiMessageElement.appendChild(actionsDiv);

            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (currentChat) {
                const msgIndex = currentChat.messages.findIndex(m => m.id === messageId);
                if (msgIndex > -1) {
                    currentChat.messages[msgIndex].text = `خطا: ${error.message}`;
                    saveChatsDebounced();
                }
            }
        }
        
        async function continueStory(instruction = null) {
            const sendButton = document.querySelector('.send-button');
            if (isGenerating || sendButton.disabled) {
                if (sendButton.disabled) {
                    showNotification("لطفا صبر کنید، دستیار هوشمند هنوز آماده نشده.", "info");
                }
                return;
            }
            
            const chatArea = document.getElementById('chat-area');
            if (chats.length === 0) createNewChat();
            
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!settings.apiKey) {
                showNotification("لطفا ابتدا کلید API خود را در تنظیمات وارد کنید.", 'error');
                return;
            }
            if (!currentChat.prompt) {
                showNotification("لطفا ابتدا یک پرامپت برای داستان خود وارد کنید.", 'error');
                openPromptModal();
                return;
            }

            isGenerating = true;
            sendButton.disabled = true;

            const isFirstMessage = currentChat.messages.length === 0;

            const messageId = messageIdCounter++;
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            messageGroup.setAttribute('data-group-id', messageId);

            const aiMessage = document.createElement('div');
            aiMessage.className = `message ai-message rtl loading`;
            aiMessage.setAttribute('data-message-id', messageId);
            const timerSpan = document.createElement('span');
            timerSpan.className = 'loading-timer';
            
            aiMessage.textContent = isFirstMessage ? 'در حال خلق داستان...' : 'در حال جستجو در حافظه... ';
            aiMessage.appendChild(timerSpan);
            messageGroup.appendChild(aiMessage);
            chatArea.appendChild(messageGroup);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            currentChat.messages.push({ id: messageId, type: 'ai', text: 'در حال پردازش...' });
            saveChatsDebounced();

            const controller = new AbortController();
            let seconds = 0;
            const timerInterval = setInterval(() => { seconds++; timerSpan.textContent = `(${seconds}s)`; }, 1000);
            activeGeneration = { messageId, chatId: currentChatId, messageGroup, controller, timerInterval };

            if (isFirstMessage) {
                handleContextRetrieved({ 
                    context: '', 
                    messageId: messageId, 
                    regenerationInstruction: null 
                });
            } else {
                const lastMessage = currentChat.messages.length > 1 ? currentChat.messages[currentChat.messages.length - 2].text : 'شروع داستان';
                worker.postMessage({ 
                    type: 'get-context', 
                    payload: { 
                        chatId: currentChatId,
                        queryText: instruction || `ادامه داستان بعد از: ${lastMessage}`,
                        messageId: messageId,
                        regenerationInstruction: instruction
                    } 
                });
            }
        }
        
        async function regenerateStory(instruction) {
             if (isGenerating || currentRegenerateMessageId === null) return;
            const sendButton = document.querySelector('.send-button');
            const chatArea = document.getElementById('chat-area');
            
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!settings.apiKey) {
                showNotification("لطفا ابتدا کلید API خود را در تنظیمات وارد کنید.", 'error');
                return;
            }
           
            isGenerating = true;
            sendButton.disabled = true;
            
            const messageId = currentRegenerateMessageId; 
            const messageGroup = document.querySelector(`.message-group[data-group-id="${messageId}"]`);
            if(!messageGroup) {
                console.error("Could not find message group to regenerate.");
                isGenerating = false;
                sendButton.disabled = false;
                return;
            }
            const aiMessage = messageGroup.querySelector('.ai-message');
            
            aiMessage.className = `message ai-message rtl loading`;
            const timerSpan = document.createElement('span');
            timerSpan.className = 'loading-timer';
            aiMessage.textContent = 'در حال جستجو در حافظه... ';
            aiMessage.appendChild(timerSpan);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            const messageIndex = currentChat.messages.findIndex(m => m.id === messageId);
            currentChat.messages[messageIndex].text = 'در حال پردازش...';
            saveChatsDebounced();

            const controller = new AbortController();
            let seconds = 0;
            const timerInterval = setInterval(() => { seconds++; timerSpan.textContent = `(${seconds}s)`; }, 1000);
            activeGeneration = { messageId, chatId: currentChatId, messageGroup, controller, timerInterval };

            const previousMessageText = messageIndex > 0 ? currentChat.messages[messageIndex - 1].text : 'شروع داستان';
            
            worker.postMessage({ 
                type: 'get-context', 
                payload: { 
                    chatId: currentChatId,
                    queryText: instruction, 
                    messageId: messageId,
                    regenerationInstruction: instruction
                } 
            });
        }

        function downloadChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            const bookData = {
                title: chat.title,
                prompt: chat.prompt,
                messages: chat.messages.map(m => ({ text: m.text }))
            };

            const blob = new Blob([JSON.stringify(bookData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const safeFileName = chat.title.replace(/[^a-z0-9-_\u0600-\u06FF]/gi, '_');
            a.download = `${safeFileName || 'Nora_Book'}.nora`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`کتاب «${chat.title}» با موفقیت دانلود شد.`, 'success');
        }

        function triggerUpload() {
            document.getElementById('import-file-input').click();
        }

        function importBook(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const bookData = JSON.parse(e.target.result);

                    if (!bookData.title || typeof bookData.prompt === 'undefined' || !Array.isArray(bookData.messages)) {
                        throw new Error('فرمت فایل کتاب نامعتبر است.');
                    }

                    const existingIds = chats.map(chat => chat.id);
                    let newId = 1;
                    while (existingIds.includes(newId)) newId++;
                    
                    let messageIdCounterForImport = messageIdCounter;

                    const newChat = {
                        id: newId,
                        title: bookData.title,
                        prompt: bookData.prompt,
                        messages: bookData.messages
                            .filter(msg => msg.text !== 'در حال پردازش...')
                            .map(msg => ({
                                id: messageIdCounterForImport++,
                                type: 'ai',
                                text: msg.text
                            }))
                    };
                    
                    messageIdCounter = messageIdCounterForImport;

                    chats.push(newChat);
                    saveChatsDebounced();
                    worker.postMessage({ type: 'create-collection', payload: { chatId: newId } });

                    showNotification(`در حال افزودن کتاب «${newChat.title}» به حافظه...`, 'info');
                    newChat.messages.forEach(message => {
                        worker.postMessage({
                            type: 'add-to-memory',
                            payload: { chatId: newId, messageId: message.id, text: message.text }
                        });
                    });

                    loadChat(newId);
                    renderChatList();
                    showNotification(`کتاب «${newChat.title}» با موفقیت آپلود شد.`, 'success');

                } catch (err) {
                    showNotification(`خطا در آپلود کتاب: ${err.message}`, 'error');
                    console.error("Import failed:", err);
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function saveChats() { localStorage.setItem('nora_writer_chats', JSON.stringify(chats)); }
        function saveChatsDebounced() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { saveChats(); console.log("Chat data saved."); }, 500); }
        function saveSettings() { localStorage.setItem('nora_writer_settings', JSON.stringify(settings)); }
        function isRTL(text) { const rtlRegex = /[\u0600-\u06FF\u0750-\u077F]/; return rtlRegex.test(text); }
        
        function renderChatList() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.setAttribute('data-chat-id', chat.id);
                chatItem.setAttribute('draggable', 'true');
                chatItem.classList.toggle('active', chat.id === currentChatId);
                chatItem.innerHTML = `
                    <div class="chat-title">${chat.title}</div>
                    <div class="chat-actions">
                        <button class="download-button" onclick="downloadChat(${chat.id})" title="دانلود کتاب">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                        <button class="edit-button" onclick="editChatTitle(${chat.id}, this)" title="ویرایش نام">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="#FF8300" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="delete-button" onclick="deleteChat(${chat.id}, this)" title="حذف کتاب">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 6L17.1991 18.0129C17.129 19.065 17.0939 19.5911 16.8667 19.99C16.6666 20.3412 16.3648 20.6235 16.0011 20.7998C15.588 21 15.0607 21 14.0062 21H9.99377C8.93927 21 8.41202 21 7.99889 20.7998C7.63517 20.6235 7.33339 20.3412 7.13332 19.99C6.90607 19.5911 6.871 19.065 6.80086 18.0129L6 6M4 6H20M16 6L15.7294 5.18807C15.4671 4.40125 15.3359 4.00784 15.0927 3.71698C14.8779 3.46013 14.6021 3.26132 14.2905 3.13878C13.9376 3 13.523 3 12.6936 3H11.3064C10.477 3 10.0624 3 9.70951 3.13878C9.39792 3.26132 9.12208 3.46013 8.90729 3.71698C8.66405 4.00784 8.53292 4.40125 8.27064 5.18807L8 6M14 10V17M10 10V17" stroke="#d32f2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>`;
                chatItem.querySelector('.chat-title').addEventListener('click', () => { loadChat(chat.id); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); });
                chatItem.addEventListener('dragstart', handleDragStart);
                chatItem.addEventListener('dragover', handleDragOver);
                chatItem.addEventListener('drop', handleDrop);
                chatItem.addEventListener('dragend', handleDragEnd);
                chatList.appendChild(chatItem);
            });
        }
        
        function loadChat(chatId) {
            currentChatId = chatId;
            const chatArea = document.getElementById('chat-area');
            const chatTitleMain = document.getElementById('chat-title-main');
            chatArea.innerHTML = '';
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                chat.messages.forEach(message => {
                    const messageGroup = document.createElement('div');
                    messageGroup.className = 'message-group';
                    messageGroup.setAttribute('data-group-id', message.id);
                    
                    const messageDiv = document.createElement('div');
                    const directionClass = isRTL(message.text) ? 'rtl' : 'ltr';
                    messageDiv.className = `message ai-message ${directionClass}`;
                    messageDiv.setAttribute('data-message-id', message.id);

                    const messageBdi = document.createElement('bdi');
                    messageBdi.textContent = message.text;
                    messageDiv.appendChild(messageBdi);
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'ai-message-actions';
                    if (message.text.startsWith('خطا:')) {
                        messageDiv.classList.add('error');
                    }
                    actionsDiv.innerHTML = `<button class="options-button" onclick="toggleAiMessageMenu(event, this)"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><div class="ai-message-context-menu"><button class="regenerate-action" onclick="openRegenerateModal(${message.id})" title="اصلاح و بازنویسی"><svg class="regenerate-svg" viewBox="0 0 24 24" width="18" height="18"><path d="M23 4v6h-6" stroke-width="2"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" stroke-width="2"></path></svg><span>اصلاح و بازنویسی</span></button></div>`;
                    messageDiv.appendChild(actionsDiv);
                    messageGroup.appendChild(messageDiv);
                    chatArea.appendChild(messageGroup);
                });
                chatTitleMain.textContent = chat.title;
                chatTitleMain.ondblclick = () => editMainChatTitle(chatId);
                chatTitleMain.oncontextmenu = (e) => { e.preventDefault(); editMainChatTitle(chatId); };
            }
            renderChatList();
        }

        function handleDragStart(e) { draggedChat = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', this.getAttribute('data-chat-id')); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleDrop(e) { e.preventDefault(); const targetChat = this; const draggedId = parseInt(draggedChat.getAttribute('data-chat-id')); const targetId = parseInt(targetChat.getAttribute('data-chat-id')); if (draggedId !== targetId) { const draggedIndex = chats.findIndex(chat => chat.id === draggedId); const targetIndex = chats.findIndex(chat => chat.id === targetId); const [draggedItem] = chats.splice(draggedIndex, 1); chats.splice(targetIndex, 0, draggedItem); saveChatsDebounced(); renderChatList(); } }
        function handleDragEnd() { this.classList.remove('dragging'); draggedChat = null; }
        function createNewChat() { if (isCreatingChat) return; isCreatingChat = true; const existingIds = chats.map(chat => chat.id); let newId = 1; while (existingIds.includes(newId)) newId++; const newChat = { id: newId, title: `کتاب جدید ${newId}`, messages: [], prompt: '' }; chats.push(newChat); currentChatId = newChat.id; saveChatsDebounced(); renderChatList(); loadChat(currentChatId); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); isCreatingChat = false; worker.postMessage({ type: 'create-collection', payload: { chatId: newId } }); }
        function clearChat() { const chatArea = document.getElementById('chat-area'); chatArea.innerHTML = ''; const currentChat = chats.find(chat => chat.id === currentChatId); if (currentChat) { currentChat.messages = []; saveChatsDebounced(); worker.postMessage({ type: 'clear-collection', payload: { chatId: currentChat.id } }); } }
        function searchChats(query) { const chatItems = document.querySelectorAll('.chat-item'); chatItems.forEach(item => { const chatId = parseInt(item.getAttribute('data-chat-id')); const chat = chats.find(c => c.id === chatId); const title = chat.title.toLowerCase(); if (title.includes(query.toLowerCase())) item.classList.remove('hidden'); else item.classList.add('hidden'); }); }
        function findScrollAnchor() { const chatArea = document.getElementById('chat-area'); const chatAreaRect = chatArea.getBoundingClientRect(); const messageGroups = chatArea.querySelectorAll('.message-group'); let firstVisibleGroup = null; for (const group of messageGroups) { const groupRect = group.getBoundingClientRect(); if (groupRect.bottom > chatAreaRect.top && groupRect.top < chatAreaRect.bottom) { firstVisibleGroup = group; break; } } if (!firstVisibleGroup) return null; const groupRect = firstVisibleGroup.getBoundingClientRect(); const distanceScrolledIntoElement = chatAreaRect.top - groupRect.top; let scrollPercentage = 0; if (distanceScrolledIntoElement > 0) scrollPercentage = distanceScrolledIntoElement / groupRect.height; return { element: firstVisibleGroup, percentage: scrollPercentage }; }
        function restoreScrollPosition(anchor) { if (!anchor || !anchor.element) return; const chatArea = document.getElementById('chat-area'); const element = anchor.element; const elementTopRelativeToContainer = element.offsetTop; const newPixelOffset = element.offsetHeight * anchor.percentage; chatArea.scrollTop = elementTopRelativeToContainer + newPixelOffset; }
        function toggleReadingMode() { const main = document.getElementById('main'); const readingModeButton = document.getElementById('reading-mode-button'); const anchor = findScrollAnchor(); readingMode = !readingMode; main.classList.toggle('reading-mode', readingMode); function enterFullScreen() { const elem = document.documentElement; if (elem.requestFullscreen) { elem.requestFullscreen(); } else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } } function exitFullScreen() { if (document.exitFullscreen) { document.exitFullscreen(); } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } } const eyeIconSVG = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.0007 12C15.0007 13.6569 13.6576 15 12.0007 15C10.3439 15 9.00073 13.6569 9.00073 12C9.00073 10.3431 10.3439 9 12.0007 9C13.6576 9 15.0007 10.3431 15.0007 12Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.0012 5C7.52354 5 3.73326 7.94288 2.45898 12C3.73324 16.0571 7.52159 19 12.0012 19C16.4788 19 20.2691 16.0571 21.5434 12C20.2691 7.94291 16.4788 5 12.0012 5Z" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`; const eyeSlashIconSVG = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.99902 3L20.999 21M9.8433 9.91364C9.32066 10.4536 8.99902 11.1892 8.99902 12C8.99902 13.6569 10.3422 15 11.999 15C12.8215 15 13.5667 14.669 14.1086 14.133M6.49902 6.64715C4.59972 7.90034 3.15305 9.78394 2.45703 12C3.73128 16.0571 7.52159 19 11.9992 19C13.9881 19 15.8414 18.4194 17.3988 17.4184M10.999 5.04939C11.328 5.01673 11.6617 5 11.9992 5C16.4769 5 20.2672 7.94291 21.5414 12C21.2607 12.894 20.8577 13.7338 20.3522 14.5" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`; readingModeButton.innerHTML = readingMode ? eyeIconSVG : eyeSlashIconSVG; readingModeButton.title = readingMode ? 'خروج از حالت مطالعه' : 'حالت مطالعه'; if (readingMode) { enterFullScreen(); } else { exitFullScreen(); } requestAnimationFrame(() => { restoreScrollPosition(anchor); }); }
        function toggleSettingsWindow() { const settingsWindow = document.getElementById('settings-window'); const apiKeyInput = document.getElementById('api-key-input'); if (settingsWindow.classList.contains('open')) { saveSettingsData(); settingsWindow.classList.remove('open'); } else { settingsWindow.classList.add('open'); apiKeyInput.value = settings.apiKey || ''; if(document.getElementById(settings.selectedModel)) document.getElementById(settings.selectedModel).checked = true; apiKeyInput.focus(); document.querySelectorAll('.radio-wrapper').forEach(wrapper => { wrapper.addEventListener('click', function() { const input = this.querySelector('input[type="radio"]'); if (input && !input.checked) { input.checked = true; saveSettingsData(); } }); }); } }
        function saveSettingsData() { const apiKeyInput = document.getElementById('api-key-input'); const selectedModelInput = document.querySelector('input[name="ai-model"]:checked'); settings.apiKey = apiKeyInput.value.trim(); if(selectedModelInput) settings.selectedModel = selectedModelInput.value; saveSettings(); }
        function toggleAboutUs() { aboutUsActive = !aboutUsActive; const sidebarMain = document.querySelector('.sidebar-main'); const aboutUsContent = document.querySelector('.about-us-content'); const aboutUsButton = document.querySelector('.about-us-button'); aboutUsButton.classList.toggle('active', aboutUsActive); if (aboutUsActive) { sidebarMain.style.display = 'none'; aboutUsContent.style.display = 'flex'; } else { sidebarMain.style.display = 'block'; aboutUsContent.style.display = 'none'; } }
        function editMainChatTitle(chatId) { const chatTitleMain = document.getElementById('chat-title-main'); const currentTitle = chatTitleMain.textContent; chatTitleMain.innerHTML = `<input type="text" value="${currentTitle}" />`; const input = chatTitleMain.querySelector('input'); input.focus(); input.setSelectionRange(input.value.length, input.value.length); input.onblur = () => saveMainChatTitle(chatId, input.value); input.onkeypress = (e) => { if (e.key === 'Enter') saveMainChatTitle(chatId, input.value); }; }
        function saveMainChatTitle(chatId, newTitle) { const chatTitleMain = document.getElementById('chat-title-main'); const chat = chats.find(c => c.id === chatId); const isDuplicate = chats.some(c => c.id !== chatId && c.title === newTitle); if (isDuplicate) { chatTitleMain.textContent = chat.title; } else { const finalTitle = newTitle.trim() || `کتاب ${chatId}`; chatTitleMain.textContent = finalTitle; if (chat) { chat.title = finalTitle; saveChatsDebounced(); renderChatList(); } } }
        function editChatTitle(chatId, button) { const chatItem = button.closest('.chat-item'); const chatTitle = chatItem.querySelector('.chat-title'); const currentTitle = chatTitle.textContent; chatTitle.innerHTML = `<input type="text" value="${currentTitle}" />`; const input = chatTitle.querySelector('input'); input.focus(); input.setSelectionRange(input.value.length, input.value.length); input.addEventListener('blur', function() { saveChatTitle(chatId, chatItem, input.value); }); input.addEventListener('keypress', function(e) { if (e.key === 'Enter') saveChatTitle(chatId, chatItem, input.value); }); }
        function saveChatTitle(chatId, chatItem, newTitle) { const chatTitle = chatItem.querySelector('.chat-title'); const chat = chats.find(c => c.id === chatId); const isDuplicate = chats.some(c => c.id !== chatId && c.title === newTitle); if (isDuplicate) { chatTitle.textContent = chat.title; } else { const finalTitle = newTitle.trim() || `کتاب ${chatId}`; chatTitle.textContent = finalTitle; if (chat) { chat.title = finalTitle; saveChatsDebounced(); document.getElementById('chat-title-main').textContent = finalTitle; } } }
        function deleteChat(chatId, button) { const chatItem = button.closest('.chat-item'); if (chatItem.classList.contains('delete-pending')) { chats = chats.filter(chat => chat.id !== chatId); saveChatsDebounced(); renderChatList(); worker.postMessage({ type: 'delete-collection', payload: { chatId } }); if (activeGeneration && activeGeneration.chatId === chatId) { activeGeneration.controller.abort(); } if (currentChatId === chatId) { const chatArea = document.getElementById('chat-area'); const chatTitleMain = document.getElementById('chat-title-main'); chatArea.innerHTML = ''; if (chats.length === 0) chatTitleMain.textContent = ''; else { currentChatId = chats[chats.length - 1].id; loadChat(currentChatId); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); } } } else { document.querySelectorAll('.chat-item.delete-pending').forEach(item => { item.classList.remove('delete-pending'); item.style.border = ''; item.style.boxShadow = ''; }); chatItem.classList.add('delete-pending'); chatItem.style.border = '2px solid #d32f2f'; chatItem.style.boxShadow = 'inset 0 0 10px rgba(211, 47, 47, 0.5)'; } }
        function toggleMenu() { const sidebar = document.getElementById('sidebar'); const menuButton = document.querySelector('.menu-button'); const isOpen = sidebar.classList.contains('open'); sidebar.classList.toggle('open'); menuButton.classList.toggle('hidden', !isOpen); if (!isOpen && aboutUsActive) toggleAboutUs(); }
        function toggleAiMessageMenu(event, buttonElement) { event.stopPropagation(); const menu = buttonElement.nextElementSibling; const isCurrentlyShown = menu.classList.contains('show'); document.querySelectorAll('.ai-message-context-menu.show').forEach(openMenu => { openMenu.classList.remove('show'); }); if (!isCurrentlyShown) { menu.classList.add('show'); } }
        function openPromptModal() { if (chats.length === 0) createNewChat(); let currentChat = chats.find(c => c.id === currentChatId); const modal = document.getElementById('prompt-modal'); const textarea = document.getElementById('prompt-modal-textarea'); textarea.value = currentChat.prompt || ''; modal.style.display = 'flex'; textarea.focus(); }
        function closePromptModal() { document.getElementById('prompt-modal').style.display = 'none'; }
        function savePrompt() { const currentChat = chats.find(c => c.id === currentChatId); if(currentChat) { const textarea = document.getElementById('prompt-modal-textarea'); currentChat.prompt = textarea.value.trim(); saveChatsDebounced(); showNotification('پرامپت ذخیره شد.', 'success'); } closePromptModal(); }
        function openRegenerateModal(messageId) { currentRegenerateMessageId = messageId; const modal = document.getElementById('regenerate-modal'); const textarea = document.getElementById('regenerate-modal-textarea'); textarea.value = ''; modal.style.display = 'flex'; textarea.focus(); }
        function closeRegenerateModal() { document.getElementById('regenerate-modal').style.display = 'none'; currentRegenerateMessageId = null; }
        function confirmRegeneration() { const textarea = document.getElementById('regenerate-modal-textarea'); const instruction = textarea.value.trim(); if (instruction) { regenerateStory(instruction); } else { showNotification('لطفا یک دستورالعمل برای بازنویسی وارد کنید.', 'error'); } closeRegenerateModal(); }
        document.addEventListener('click', function(e) { const sidebar = document.getElementById('sidebar'); const menuButton = document.querySelector('.menu-button'); const settingsWindow = document.getElementById('settings-window'); const settingsButton = document.querySelector('.settings-button'); const chatTitleMain = document.getElementById('chat-title-main'); const isSidebarOpen = sidebar.classList.contains('open'); const isSettingsWindowOpen = settingsWindow.classList.contains('open'); if (isSidebarOpen && !sidebar.contains(e.target) && !menuButton.contains(e.target)) { sidebar.classList.remove('open'); menuButton.classList.remove('hidden'); if (aboutUsActive) toggleAboutUs(); } if (isSettingsWindowOpen && !settingsWindow.contains(e.target) && !settingsButton.contains(e.target)) { saveSettingsData(); settingsWindow.classList.remove('open'); } document.querySelectorAll('.chat-item.delete-pending').forEach(item => { if (!item.contains(e.target)) { item.classList.remove('delete-pending'); item.style.border = ''; item.style.boxShadow = ''; } }); if (chatTitleMain.querySelector('input') && !chatTitleMain.contains(e.target)) { const input = chatTitleMain.querySelector('input'); saveMainChatTitle(currentChatId, input.value); } document.querySelectorAll('.ai-message-context-menu.show').forEach(openMenu => { if (!openMenu.closest('.message').contains(e.target)) { openMenu.classList.remove('show'); } }); });
        document.addEventListener('keydown', function(e) { if (e.ctrlKey && e.key === 'Enter') continueStory(); });
        document.addEventListener('DOMContentLoaded', () => { renderChatList(); if (chats.length > 0) { loadChat(currentChatId); setTimeout(() => { document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight; }, 0); } document.getElementById('confirm-prompt-btn').onclick = savePrompt; document.getElementById('cancel-prompt-btn').onclick = closePromptModal; document.getElementById('prompt-modal').onclick = (e) => { if (e.target.id === 'prompt-modal') closePromptModal(); }; document.getElementById('confirm-regenerate-btn').onclick = confirmRegeneration; document.getElementById('cancel-regenerate-btn').onclick = closeRegenerateModal; document.getElementById('regenerate-modal').onclick = (e) => { if (e.target.id === 'regenerate-modal') closeRegenerateModal(); }; document.getElementById('import-file-input').addEventListener('change', importBook); });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js?v=' + new Date().getTime()).then(registration => { console.log('Nora PWA ServiceWorker registered successfully.'); }).catch(err => { console.error('ServiceWorker registration failed: ', err); }); }); }
    </script>
</body>
</html>
